<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.1.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"blog.cwiki.cn","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Zzz个人博客">
<meta property="og:url" content="https://blog.cwiki.cn/page/2/index.html">
<meta property="og:site_name" content="Zzz个人博客">
<meta property="og:locale">
<meta property="article:author" content="zauther">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://blog.cwiki.cn/page/2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh'
  };
</script>

  <title>Zzz个人博客</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-97381903-1"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-97381903-1');
      }
    </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Zzz个人博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="https://blog.cwiki.cn/2021/04/04/%E4%BB%8E%E9%9B%B6%E5%BC%80%E6%9E%84%E5%BB%BA%E6%A0%91%E8%8E%93%E6%B4%BE64%E4%BD%8D%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="zauther">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zzz个人博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/04/%E4%BB%8E%E9%9B%B6%E5%BC%80%E6%9E%84%E5%BB%BA%E6%A0%91%E8%8E%93%E6%B4%BE64%E4%BD%8D%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" class="post-title-link" itemprop="url">从零开构建树莓派64位操作系统</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-04-04 21:45:00" itemprop="dateCreated datePublished" datetime="2021-04-04T21:45:00+08:00">2021-04-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-05-10 00:33:07" itemprop="dateModified" datetime="2022-05-10T00:33:07+08:00">2022-05-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>25k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>23 mins.</span>
            </span>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="1-首次安装树莓派"><a href="#1-首次安装树莓派" class="headerlink" title="1. 首次安装树莓派"></a>1. 首次安装树莓派</h2><h3 id="1-1-安装树莓派"><a href="#1-1-安装树莓派" class="headerlink" title="1.1 安装树莓派"></a>1.1 安装树莓派</h3><h4 id="1-1-1-下载树莓派镜像-可跳过"><a href="#1-1-1-下载树莓派镜像-可跳过" class="headerlink" title="1.1.1 下载树莓派镜像(可跳过)"></a>1.1.1 下载树莓派镜像(可跳过)</h4><p>从<a target="_blank" rel="noopener" href="https://www.raspberrypi.org/software/operating-systems/">https://www.raspberrypi.org/software/operating-systems/</a> 下载树莓派镜像，为了快速下载，这里下载的是 <code>Raspberry Pi OS Lite</code> ，体积最小，后面主要在命令行环境使用。这里下载的版本是 <code>2021-03-04-raspios-buster-armhf-lite.zip</code> <br>准备2张SD卡，一张安装树莓派系统（这里取代号A卡），另外一张（B卡）用于我们自己的构建系统。</p>
<h4 id="1-1-2-安装树莓派系统"><a href="#1-1-2-安装树莓派系统" class="headerlink" title="1.1.2 安装树莓派系统"></a>1.1.2 安装树莓派系统</h4><p>在Ubuntu主机上安装树莓派烧写工具 <code>rpi-imager</code> </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install rpi-imager</span><br></pre></td></tr></table></figure>

<p>在命令行执行 <code>rpi-imager</code> 后会出现工具</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpi-imager</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/Zauther/figurebed/imgs/20210404180357.png"><br>选择刚才下载的zip文件：<br><img src="https://cdn.jsdelivr.net/gh/Zauther/figurebed/imgs/20210404192504.png"><br>或者直接选择需要安装的系统在线安装<br><img src="https://cdn.jsdelivr.net/gh/Zauther/figurebed/imgs/20210404192732.png"><br>选择A卡，点击烧录即可完成安装。</p>
<h4 id="1-1-3-无屏幕键盘初始化树莓派"><a href="#1-1-3-无屏幕键盘初始化树莓派" class="headerlink" title="1.1.3 无屏幕键盘初始化树莓派"></a>1.1.3 无屏幕键盘初始化树莓派</h4><p>如果没有屏幕，可通过配置WIFI和SSH，通过SSH来连接树莓派。在烧录系统到A卡后，A卡上有2个分区 <code>root</code> <code>rootfs</code> ， <code>root</code> 分区上是包含树莓派引导文件已经Linux Kerne、设备数文件等等，具体的内容后面会详细介绍。<br><strong>配置网络</strong><br>如果有网线，直接插线就可以。连接WIFI需要以下操作：<br>在 <code>root</code> 分区新建 <code>wpa_supplicant.conf</code> 文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ctrl_interface=DIR=/var/run/wpa_supplicant GROUP=netdev</span><br><span class="line">update_config=1</span><br><span class="line">country=US</span><br><span class="line"></span><br><span class="line">network=&#123;</span><br><span class="line">ssid=&quot;WIFI名称&quot;</span><br><span class="line">psk=&quot;WIFI密码&quot;</span><br><span class="line">key_mgmt=WPA-PSK</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>配置SSH</strong><br>在<code>root</code>  分区新建名为SSH的文件即可。<br>将A卡插入树莓派即可启动树莓派系统。</p>
<h3 id="1-2-树莓派系统初始化"><a href="#1-2-树莓派系统初始化" class="headerlink" title="1.2 树莓派系统初始化"></a>1.2 树莓派系统初始化</h3><h4 id="1-2-1-SSH连接"><a href="#1-2-1-SSH连接" class="headerlink" title="1.2.1 SSH连接"></a>1.2.1 SSH连接</h4><p>通过SSH连接树莓派：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh pi@xx.xx.xx.xx</span><br></pre></td></tr></table></figure>

<p>默认密码为：<code>raspberry</code><br>到此即可通过SSH来使用树莓派。<br><strong>修改密码：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">passwd</span></span><br><span class="line">Changing password for pi.</span><br><span class="line">Current password: </span><br><span class="line">New password: </span><br><span class="line">Retype new password:</span><br></pre></td></tr></table></figure>

<p>输入默认密码 <code>raspberry</code>  和自己的密码。</p>
<h4 id="1-2-2-树莓派系统配置和VNC连接-可选"><a href="#1-2-2-树莓派系统配置和VNC连接-可选" class="headerlink" title="1.2.2 树莓派系统配置和VNC连接(可选)"></a>1.2.2 树莓派系统配置和VNC连接(可选)</h4><p>通过raspi-config可对树莓派进行设置，比如打来<code>GPIO</code> 端口，开启<code>VNC</code> 服务等</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo raspi-config</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/Zauther/figurebed/imgs/20210404195151.png"><br>在 <code>3 Interface Options</code> &#x2F; <code>P3 VNC</code>  中开启<code>VNC</code> 。<br>在Ubuntu中安装VNC客户端:<br>在 <a target="_blank" rel="noopener" href="https://www.realvnc.com/en/connect/download/viewer/linux/">https://www.realvnc.com/en/connect/download/viewer/linux/</a> 中下载VNC View <a target="_blank" rel="noopener" href="https://www.realvnc.com/download/file/viewer.files/VNC-Viewer-6.20.529-Linux-x64.deb">https://www.realvnc.com/download/file/viewer.files/VNC-Viewer-6.20.529-Linux-x64.deb</a><br>安装：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo dpkg -i VNC-Viewer-6.20.529-Linux-x64.deb</span><br></pre></td></tr></table></figure>

<p>打开vnc view，新建Connection 输入树莓派IP地址和用户名密码即可进入远程桌面。</p>
<p>至此完成了树莓派系统的初步安装。</p>
<h2 id="2-从零构建树莓派"><a href="#2-从零构建树莓派" class="headerlink" title="2 从零构建树莓派"></a>2 从零构建树莓派</h2><h3 id="2-1-串口连接树莓派"><a href="#2-1-串口连接树莓派" class="headerlink" title="2.1 串口连接树莓派"></a>2.1 串口连接树莓派</h3><p>这一步需要使用到USB转TTL串口的线，淘宝和京东有售。<br><img src="https://cdn.jsdelivr.net/gh/Zauther/figurebed/imgs/20210404200452.png"></p>
<h4 id="2-1-2-串口接线"><a href="#2-1-2-串口接线" class="headerlink" title="2.1.2 串口接线"></a>2.1.2 串口接线</h4><p>USB 串口工具<br><img src="https://cdn.jsdelivr.net/gh/Zauther/figurebed/imgs/20210404204409.png"></p>
<p>树莓派GPIO借口<br><img src="https://cdn.jsdelivr.net/gh/Zauther/figurebed/imgs/20210404205936.png"><br>1,2号pin是远离树莓派USB的那一端。</p>
<p>接线：<br>usb转串口工具的TX连接树莓派的RX，RX连接树莓派的TX，VCC与GND正常连接</p>
<p>通过 <code>raspi-config</code>  设置 <code>3 Interface Options </code> &#x2F; <code>P6 Serial Port </code>  开启串口<br><img src="https://cdn.jsdelivr.net/gh/Zauther/figurebed/imgs/20210404204614.png"></p>
<h4 id="2-1-2-Ubuntu上安装串口工具"><a href="#2-1-2-Ubuntu上安装串口工具" class="headerlink" title="2.1.2 Ubuntu上安装串口工具"></a>2.1.2 Ubuntu上安装串口工具</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install minicom</span><br></pre></td></tr></table></figure>

<p>启动minicom</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo minicom -D /dev/ttyUSB0</span><br></pre></td></tr></table></figure>

<p><code>-D</code> 参数Device，<code>ttyUSB0</code> 即为电脑连接上的USB串口。</p>
<p>在接好线，插好USB，启动minicom后，接通树莓派电源，可看到minicom打印内核启动过程：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br></pre></td><td class="code"><pre><span class="line">sudo minicom -D /dev/ttyUSB0                  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Welcome to minicom 2.7.1</span><br><span class="line"></span><br><span class="line">OPTIONS: I18n </span><br><span class="line">Compiled on Dec 23 2019, 02:06:26.</span><br><span class="line">Port /dev/ttyUSB0, 20:27:33</span><br><span class="line"></span><br><span class="line">Press CTRL-A Z for help on special keys</span><br><span class="line"></span><br><span class="line">[    0.000000] Booting Linux on physical CPU 0x0</span><br><span class="line">[    0.000000] Linux version 5.10.11-v7l+ (dom@buildbot) (arm-linux-gnueabihf-gcc-8 (Ubuntu/Linaro 8.4.0-3ubuntu1) 8.4.0, GNU ld (GNU Binutils f1</span><br><span class="line">[    0.000000] CPU: ARMv7 Processor [410fd083] revision 3 (ARMv7), cr=30c5383d</span><br><span class="line">[    0.000000] CPU: div instructions available: patching division code</span><br><span class="line">[    0.000000] CPU: PIPT / VIPT nonaliasing data cache, PIPT instruction cache</span><br><span class="line">[    0.000000] OF: fdt: Machine model: Raspberry Pi 4 Model B Rev 1.2</span><br><span class="line">[    0.000000] Memory policy: Data cache writealloc</span><br><span class="line">[    0.000000] Reserved memory: created CMA memory pool at 0x000000001ec00000, size 256 MiB</span><br><span class="line">[    0.000000] OF: reserved mem: initialized node linux,cma, compatible id shared-dma-pool</span><br><span class="line">[    0.000000] Zone ranges:</span><br><span class="line">[    0.000000]   DMA      [mem 0x0000000000000000-0x000000002fffffff]</span><br><span class="line">[    0.000000]   Normal   empty</span><br><span class="line">[    0.000000]   HighMem  [mem 0x0000000030000000-0x00000000fbffffff]</span><br><span class="line">[    0.000000] Movable zone start for each node</span><br><span class="line">[    0.000000] Early memory node ranges</span><br><span class="line">[    0.000000]   node   0: [mem 0x0000000000000000-0x0000000037ffffff]</span><br><span class="line">[    0.000000]   node   0: [mem 0x0000000040000000-0x00000000fbffffff]</span><br><span class="line">[    0.000000] Initmem setup node 0 [mem 0x0000000000000000-0x00000000fbffffff]</span><br><span class="line">[    0.000000] percpu: Embedded 20 pages/cpu s50636 r8192 d23092 u81920</span><br><span class="line">[    0.000000] Built 1 zonelists, mobility grouping on.  Total pages: 997120</span><br><span class="line">[    0.000000] Kernel command line: coherent_pool=1M 8250.nr_uarts=1 snd_bcm2835.enable_compat_alsa=0 snd_bcm2835.enable_hdmi=1 video=HDMI-A-1:1t</span><br><span class="line">[    0.000000] Kernel parameter elevator= does not have any effect anymore.</span><br><span class="line">[    0.000000] Please use sysfs to set IO scheduler for individual devices.</span><br><span class="line">[    0.000000] Dentry cache hash table entries: 131072 (order: 7, 524288 bytes, linear)</span><br><span class="line">[    0.000000] Inode-cache hash table entries: 65536 (order: 6, 262144 bytes, linear)</span><br><span class="line">[    0.000000] mem auto-init: stack:off, heap alloc:off, heap free:off</span><br><span class="line">[    0.000000] software IO TLB: mapped [mem 0x0000000017cc0000-0x000000001bcc0000] (64MB)</span><br><span class="line">[    0.000000] Memory: 3602320K/3997696K available (10240K kernel code, 1354K rwdata, 3152K rodata, 2048K init, 890K bss, 133232K reserved, 2621)</span><br><span class="line">[    0.000000] SLUB: HWalign=64, Order=0-3, MinObjects=0, CPUs=4, Nodes=1</span><br><span class="line">[    0.000000] ftrace: allocating 33824 entries in 67 pages</span><br><span class="line">[    0.000000] ftrace: allocated 67 pages with 3 groups</span><br><span class="line">[    0.000000] rcu: Hierarchical RCU implementation.</span><br><span class="line">[    0.000000]  Rude variant of Tasks RCU enabled.</span><br><span class="line">[    0.000000]  Tracing variant of Tasks RCU enabled.</span><br><span class="line">[    0.000000] rcu: RCU calculated value of scheduler-enlistment delay is 10 jiffies.</span><br><span class="line">[    0.000000] NR_IRQS: 16, nr_irqs: 16, preallocated irqs: 16</span><br><span class="line">[    0.000000] GIC: Using split EOI/Deactivate mode</span><br><span class="line">[    0.000000] random: get_random_bytes called from start_kernel+0x3c8/0x59c with crng_init=0</span><br><span class="line">[    0.000008] sched_clock: 32 bits at 1000kHz, resolution 1000ns, wraps every 2147483647500ns</span><br><span class="line">[    0.000035] clocksource: timer: mask: 0xffffffff max_cycles: 0xffffffff, max_idle_ns: 1911260446275 ns</span><br><span class="line">[    0.000099] bcm2835: system timer (irq = 25)</span><br><span class="line">[    0.000743] arch_timer: cp15 timer(s) running at 54.00MHz (phys).</span><br><span class="line">[    0.000765] clocksource: arch_sys_counter: mask: 0xffffffffffffff max_cycles: 0xc743ce346, max_idle_ns: 440795203123 ns</span><br><span class="line">[    0.000786] sched_clock: 56 bits at 54MHz, resolution 18ns, wraps every 4398046511102ns</span><br><span class="line">[    0.000804] Switching to timer-based delay loop, resolution 18ns</span><br><span class="line">[    0.001051] Console: colour dummy device 80x30</span><br><span class="line">[    0.001772] printk: console [tty1] enabled</span><br><span class="line">[    0.001840] Calibrating delay loop (skipped), value calculated using timer frequency.. 108.00 BogoMIPS (lpj=540000)</span><br><span class="line">[    0.001894] pid_max: default: 32768 minimum: 301</span><br><span class="line">[    0.002074] LSM: Security Framework initializing</span><br><span class="line">[    0.002266] Mount-cache hash table entries: 2048 (order: 1, 8192 bytes, linear)</span><br><span class="line">[    0.002311] Mountpoint-cache hash table entries: 2048 (order: 1, 8192 bytes, linear)</span><br><span class="line">[    0.003882] Disabling memory control group subsystem</span><br><span class="line">[    0.004016] CPU: Testing write buffer coherency: ok</span><br><span class="line">[    0.004476] CPU0: thread -1, cpu 0, socket 0, mpidr 80000000</span><br><span class="line">[    0.005683] Setting up static identity map for 0x200000 - 0x20003c</span><br><span class="line">[    0.005896] rcu: Hierarchical SRCU implementation.</span><br><span class="line">[    0.006824] smp: Bringing up secondary CPUs ...</span><br><span class="line">[    0.008018] CPU1: thread -1, cpu 1, socket 0, mpidr 80000001</span><br><span class="line">[    0.009364] CPU2: thread -1, cpu 2, socket 0, mpidr 80000002</span><br><span class="line">[    0.010646] CPU3: thread -1, cpu 3, socket 0, mpidr 80000003</span><br><span class="line">[    0.010895] smp: Brought up 1 node, 4 CPUs</span><br><span class="line">[    0.010927] SMP: Total of 4 processors activated (432.00 BogoMIPS).</span><br><span class="line">[    0.010957] CPU: All CPU(s) started in HYP mode.</span><br><span class="line">[    0.010984] CPU: Virtualization extensions available.</span><br><span class="line">[    0.011809] devtmpfs: initialized</span><br><span class="line">[    0.025623] VFP support v0.3: implementor 41 architecture 3 part 40 variant 8 rev 0</span><br><span class="line">[    0.025866] clocksource: jiffies: mask: 0xffffffff max_cycles: 0xffffffff, max_idle_ns: 19112604462750000 ns</span><br><span class="line">[    0.025919] futex hash table entries: 1024 (order: 4, 65536 bytes, linear)</span><br><span class="line">[    0.032638] pinctrl core: initialized pinctrl subsystem</span><br><span class="line">[    0.033713] NET: Registered protocol family 16</span><br><span class="line">[    0.037476] DMA: preallocated 1024 KiB pool for atomic coherent allocations</span><br><span class="line">[    0.038273] audit: initializing netlink subsys (disabled)</span><br><span class="line">[    0.038568] audit: type=2000 audit(0.030:1): state=initialized audit_enabled=0 res=1</span><br><span class="line">[    0.039138] thermal_sys: Registered thermal governor &#x27;step_wise&#x27;</span><br><span class="line">[    0.039819] hw-breakpoint: found 5 (+1 reserved) breakpoint and 4 watchpoint registers.</span><br><span class="line">[    0.039873] hw-breakpoint: maximum watchpoint size is 8 bytes.</span><br><span class="line">[    0.040268] Serial: AMBA PL011 UART driver</span><br><span class="line">[    0.072212] bcm2835-mbox fe00b880.mailbox: mailbox enabled</span><br><span class="line">[    0.090908] raspberrypi-firmware soc:firmware: Attached to firmware from 2021-01-27T22:19:57, variant start</span><br><span class="line">[    0.100922] raspberrypi-firmware soc:firmware: Firmware hash is 99d9a48302e4553cff3688692bb7e9ac760a03fa</span><br><span class="line">[    0.145578] bcm2835-dma fe007000.dma: DMA legacy API manager, dmachans=0x1</span><br><span class="line">[    0.149725] vgaarb: loaded</span><br><span class="line">[    0.150191] SCSI subsystem initialized</span><br><span class="line">[    0.150419] usbcore: registered new interface driver usbfs</span><br><span class="line">[    0.150507] usbcore: registered new interface driver hub</span><br><span class="line">[    0.150595] usbcore: registered new device driver usb</span><br><span class="line">[    0.151041] usb_phy_generic phy: supply vcc not found, using dummy regulator</span><br><span class="line">[    0.153196] clocksource: Switched to clocksource arch_sys_counter</span><br><span class="line">[    1.180263] VFS: Disk quotas dquot_6.6.0</span><br><span class="line">[    1.180389] VFS: Dquot-cache hash table entries: 1024 (order 0, 4096 bytes)</span><br><span class="line">[    1.180588] FS-Cache: Loaded</span><br><span class="line">[    1.180789] CacheFiles: Loaded</span><br><span class="line">[    1.181786] simple-framebuffer 3e6c7000.framebuffer: framebuffer at 0x3e6c7000, 0x500000 bytes, mapped to 0x(ptrval)</span><br><span class="line">[    1.181830] simple-framebuffer 3e6c7000.framebuffer: format=a8r8g8b8, mode=1280x1024x32, linelength=5120</span><br><span class="line">[    1.188675] Console: switching to colour frame buffer device 160x64</span><br><span class="line">[    1.194941] simple-framebuffer 3e6c7000.framebuffer: fb0: simplefb registered!</span><br><span class="line">[    1.204680] NET: Registered protocol family 2</span><br><span class="line">[    1.205611] tcp_listen_portaddr_hash hash table entries: 512 (order: 0, 6144 bytes, linear)</span><br><span class="line">[    1.205834] TCP established hash table entries: 8192 (order: 3, 32768 bytes, linear)</span><br><span class="line">[    1.205979] TCP bind hash table entries: 8192 (order: 4, 65536 bytes, linear)</span><br><span class="line">[    1.206114] TCP: Hash tables configured (established 8192 bind 8192)</span><br><span class="line">[    1.206324] UDP hash table entries: 512 (order: 2, 16384 bytes, linear)</span><br><span class="line">[    1.206423] UDP-Lite hash table entries: 512 (order: 2, 16384 bytes, linear)</span><br><span class="line">[    1.206743] NET: Registered protocol family 1</span><br><span class="line">[    1.207511] RPC: Registered named UNIX socket transport module.</span><br><span class="line">[    1.207589] RPC: Registered udp transport module.</span><br><span class="line">[    1.207652] RPC: Registered tcp transport module.</span><br><span class="line">[    1.207714] RPC: Registered tcp NFSv4.1 backchannel transport module.</span><br><span class="line">[    1.207799] PCI: CLS 0 bytes, default 64</span><br><span class="line">[    1.210729] Initialise system trusted keyrings</span><br><span class="line">[    1.211026] workingset: timestamp_bits=14 max_order=20 bucket_order=6</span><br><span class="line">[    1.219381] zbud: loaded</span><br><span class="line">[    1.221358] FS-Cache: Netfs &#x27;nfs&#x27; registered for caching</span><br><span class="line">[    1.222193] NFS: Registering the id_resolver key type</span><br><span class="line">[    1.222304] Key type id_resolver registered</span><br><span class="line">[    1.222364] Key type id_legacy registered</span><br><span class="line">[    1.222547] nfs4filelayout_init: NFSv4 File Layout Driver Registering...</span><br><span class="line">[    1.223725] Key type asymmetric registered</span><br><span class="line">[    1.223789] Asymmetric key parser &#x27;x509&#x27; registered</span><br><span class="line">[    1.224032] bounce: pool size: 64 pages</span><br><span class="line">[    1.224117] Block layer SCSI generic (bsg) driver version 0.4 loaded (major 249)</span><br><span class="line">[    1.224399] io scheduler mq-deadline registered</span><br><span class="line">[    1.224465] io scheduler kyber registered</span><br><span class="line">[    1.228738] brcm-pcie fd500000.pcie: host bridge /scb/pcie@7d500000 ranges:</span><br><span class="line">[    1.231271] brcm-pcie fd500000.pcie:   No bus range found for /scb/pcie@7d500000, using [bus 00-ff]</span><br><span class="line">[    1.233925] brcm-pcie fd500000.pcie:      MEM 0x0600000000..0x063fffffff -&gt; 0x00c0000000</span><br><span class="line">[    1.236493] brcm-pcie fd500000.pcie:   IB MEM 0x0000000000..0x00bfffffff -&gt; 0x0400000000</span><br><span class="line">[    1.295300] brcm-pcie fd500000.pcie: link up, 5.0 GT/s PCIe x1 (SSC)</span><br><span class="line">[    1.298093] brcm-pcie fd500000.pcie: PCI host bridge to bus 0000:00</span><br><span class="line">[    1.300511] pci_bus 0000:00: root bus resource [bus 00-ff]</span><br><span class="line">[    1.302938] pci_bus 0000:00: root bus resource [mem 0x600000000-0x63fffffff] (bus address [0xc0000000-0xffffffff])</span><br><span class="line">[    1.305532] pci 0000:00:00.0: [14e4:2711] type 01 class 0x060400</span><br><span class="line">[    1.308205] pci 0000:00:00.0: PME# supported from D0 D3hot</span><br><span class="line">[    1.314106] PCI: bus0: Fast back to back transfers disabled</span><br><span class="line">[    1.316839] pci 0000:01:00.0: [1106:3483] type 00 class 0x0c0330</span><br><span class="line">[    1.319343] pci 0000:01:00.0: reg 0x10: [mem 0x00000000-0x00000fff 64bit]</span><br><span class="line">[    1.322172] pci 0000:01:00.0: PME# supported from D0 D3cold</span><br><span class="line">[    1.328028] PCI: bus1: Fast back to back transfers disabled</span><br><span class="line">[    1.330422] pci 0000:00:00.0: BAR 8: assigned [mem 0x600000000-0x6000fffff]</span><br><span class="line">[    1.332810] pci 0000:01:00.0: BAR 0: assigned [mem 0x600000000-0x600000fff 64bit]</span><br><span class="line">[    1.335291] pci 0000:00:00.0: PCI bridge to [bus 01]</span><br><span class="line">[    1.337675] pci 0000:00:00.0:   bridge window [mem 0x600000000-0x6000fffff]</span><br><span class="line">[    1.340468] pcieport 0000:00:00.0: enabling device (0140 -&gt; 0142)</span><br><span class="line">[    1.343081] pcieport 0000:00:00.0: PME: Signaling with IRQ 63</span><br><span class="line">[    1.351160] Serial: 8250/16550 driver, 1 ports, IRQ sharing enabled</span><br><span class="line">[    1.354458] bcm2835-aux-uart fe215040.serial: there is not valid maps for state default</span><br><span class="line">[    1.359294] iproc-rng200 fe104000.rng: hwrng registered</span><br><span class="line">[    1.361981] vc-mem: phys_addr:0x00000000 mem_base=0x3ec00000 mem_size:0x40000000(1024 MiB)</span><br><span class="line">[    1.365371] gpiomem-bcm2835 fe200000.gpiomem: Initialised: Registers at 0xfe200000</span><br><span class="line">[    1.380748] brd: module loaded</span><br><span class="line">[    1.395318] loop: module loaded</span><br><span class="line">[    1.399348] Loading iSCSI transport class v2.0-870.</span><br><span class="line">[    1.404157] libphy: Fixed MDIO Bus: probed</span><br><span class="line">[    1.407776] bcmgenet fd580000.ethernet: GENET 5.0 EPHY: 0x0000</span><br><span class="line">[    1.423223] libphy: bcmgenet MII bus: probed</span><br><span class="line">[    1.503347] unimac-mdio unimac-mdio.-19: Broadcom UniMAC MDIO bus</span><br><span class="line">[    1.506805] usbcore: registered new interface driver r8152</span><br><span class="line">[    1.509183] usbcore: registered new interface driver lan78xx</span><br><span class="line">[    1.511502] usbcore: registered new interface driver smsc95xx</span><br><span class="line">[    1.515385] xhci_hcd 0000:01:00.0: enabling device (0140 -&gt; 0142)</span><br><span class="line">[    1.517778] xhci_hcd 0000:01:00.0: xHCI Host Controller</span><br><span class="line">[    1.520019] xhci_hcd 0000:01:00.0: new USB bus registered, assigned bus number 1</span><br><span class="line">[    1.525563] xhci_hcd 0000:01:00.0: hcc params 0x002841eb hci version 0x100 quirks 0x0000030000000890</span><br><span class="line">[    1.529114] usb usb1: New USB device found, idVendor=1d6b, idProduct=0002, bcdDevice= 5.10</span><br><span class="line">[    1.531401] usb usb1: New USB device strings: Mfr=3, Product=2, SerialNumber=1</span><br><span class="line">[    1.533729] usb usb1: Product: xHCI Host Controller</span><br><span class="line">[    1.536026] usb usb1: Manufacturer: Linux 5.10.11-v7l+ xhci-hcd</span><br><span class="line">[    1.538319] usb usb1: SerialNumber: 0000:01:00.0</span><br><span class="line">[    1.541333] hub 1-0:1.0: USB hub found</span><br><span class="line">[    1.543716] hub 1-0:1.0: 1 port detected</span><br><span class="line">[    1.546630] xhci_hcd 0000:01:00.0: xHCI Host Controller</span><br><span class="line">[    1.548897] xhci_hcd 0000:01:00.0: new USB bus registered, assigned bus number 2</span><br><span class="line">[    1.551175] xhci_hcd 0000:01:00.0: Host supports USB 3.0 SuperSpeed</span><br><span class="line">[    1.553989] usb usb2: New USB device found, idVendor=1d6b, idProduct=0003, bcdDevice= 5.10</span><br><span class="line">[    1.556309] usb usb2: New USB device strings: Mfr=3, Product=2, SerialNumber=1</span><br><span class="line">[    1.558613] usb usb2: Product: xHCI Host Controller</span><br><span class="line">[    1.560891] usb usb2: Manufacturer: Linux 5.10.11-v7l+ xhci-hcd</span><br><span class="line">[    1.563206] usb usb2: SerialNumber: 0000:01:00.0</span><br><span class="line">[    1.566198] hub 2-0:1.0: USB hub found</span><br><span class="line">[    1.568559] hub 2-0:1.0: 4 ports detected</span><br><span class="line">[    1.572456] dwc_otg: version 3.00a 10-AUG-2012 (platform bus)</span><br><span class="line">[    1.575615] usbcore: registered new interface driver uas</span><br><span class="line">[    1.577961] usbcore: registered new interface driver usb-storage</span><br><span class="line">[    1.580371] mousedev: PS/2 mouse device common for all mice</span><br><span class="line">[    1.584260] bcm2835-wdt bcm2835-wdt: Broadcom BCM2835 watchdog timer</span><br><span class="line">[    1.589977] sdhci: Secure Digital Host Controller Interface driver</span><br><span class="line">[    1.592240] sdhci: Copyright(c) Pierre Ossman</span><br><span class="line">[    1.595223] sdhci-pltfm: SDHCI platform and OF driver helper</span><br><span class="line">[    1.600204] ledtrig-cpu: registered to indicate activity on CPUs</span><br><span class="line">[    1.602781] hid: raw HID events driver (C) Jiri Kosina</span><br><span class="line">[    1.605191] usbcore: registered new interface driver usbhid</span><br><span class="line">[    1.607409] usbhid: USB HID core driver</span><br><span class="line">[    1.614965] Initializing XFRM netlink socket</span><br><span class="line">[    1.617362] NET: Registered protocol family 17</span><br><span class="line">[    1.619680] Key type dns_resolver registered</span><br><span class="line">[    1.622214] Registering SWP/SWPB emulation handler</span><br><span class="line">[    1.624581] registered taskstats version 1</span><br><span class="line">[    1.626751] Loading compiled-in X.509 certificates</span><br><span class="line">[    1.629732] Key type ._fscrypt registered</span><br><span class="line">[    1.631899] Key type .fscrypt registered</span><br><span class="line">[    1.634124] Key type fscrypt-provisioning registered</span><br><span class="line">[    1.647476] uart-pl011 fe201000.serial: there is not valid maps for state default</span><br><span class="line">[    1.649974] uart-pl011 fe201000.serial: cts_event_workaround enabled</span><br><span class="line">[    1.652213] fe201000.serial: ttyAMA0 at MMIO 0xfe201000 (irq = 36, base_baud = 0) is a PL011 rev2</span><br><span class="line">[    1.661041] bcm2835-aux-uart fe215040.serial: there is not valid maps for state default</span><br><span class="line">[    1.664051] printk: console [ttyS0] disabled</span><br><span class="line">[    1.666328] fe215040.serial: ttyS0 at MMIO 0xfe215040 (irq = 37, base_baud = 62500000) is a 16550</span><br><span class="line">[    2.967163] printk: console [ttyS0] enabled</span><br><span class="line">[    2.976253] bcm2835-power bcm2835-power: Broadcom BCM2835 power domains driver</span><br><span class="line">[    2.989191] of_cfs_init</span><br><span class="line">[    2.994060] of_cfs_init: OK</span><br><span class="line">[    3.037147] mmc0: SDHCI controller on fe340000.emmc2 [fe340000.emmc2] using ADMA</span><br><span class="line">[    3.048226] Waiting for root device PARTUUID=37dc5df3-02...</span><br><span class="line">[    3.123239] usb 1-1: new high-speed USB device number 2 using xhci_hcd</span><br><span class="line">[    3.148244] mmc0: new ultra high speed DDR50 SDHC card at address aaaa</span><br><span class="line">[    3.157974] mmcblk0: mmc0:aaaa SC16G 14.8 GiB</span><br><span class="line">[    3.170257]  mmcblk0: p1 p2</span><br><span class="line">[    3.213492] EXT4-fs (mmcblk0p2): mounted filesystem with ordered data mode. Opts: (null)</span><br><span class="line">[    3.224119] VFS: Mounted root (ext4 filesystem) readonly on device 179:2.</span><br><span class="line">[    3.242393] devtmpfs: mounted</span><br><span class="line">[    3.256691] Freeing unused kernel memory: 2048K</span><br><span class="line">[    3.263934] Run /sbin/init as init process</span><br><span class="line">[    3.305845] usb 1-1: New USB device found, idVendor=2109, idProduct=3431, bcdDevice= 4.21</span><br><span class="line">[    3.316511] usb 1-1: New USB device strings: Mfr=0, Product=1, SerialNumber=0</span><br><span class="line">[    3.326113] usb 1-1: Product: USB2.0 Hub</span><br><span class="line">[    3.334293] hub 1-1:1.0: USB hub found</span><br><span class="line">[    3.340665] hub 1-1:1.0: 4 ports detected</span><br><span class="line">[    3.357666] random: fast init done</span><br><span class="line">[    3.709677] systemd[1]: System time before build time, advancing clock.</span><br><span class="line">[    3.820447] NET: Registered protocol family 10</span><br><span class="line">[    3.828660] Segment Routing with IPv6</span><br><span class="line">[    3.894632] systemd[1]: systemd 241 running in system mode. (+PAM +AUDIT +SELINUX +IMA +APPARMOR +SMACK +SYSVINIT +UTMP +LIBCRYPTSETUP +GCRYP)</span><br><span class="line">[    3.922400] systemd[1]: Detected architecture arm.</span><br><span class="line">[    4.013351] systemd[1]: Set hostname to &lt;raspberrypi&gt;.</span><br><span class="line">[    4.784874] random: systemd: uninitialized urandom read (16 bytes read)</span><br><span class="line">[    4.807407] random: systemd: uninitialized urandom read (16 bytes read)</span><br><span class="line">[    4.821131] systemd[1]: Created slice system-systemd\x2dfsck.slice.</span><br><span class="line">[    4.833750] random: systemd: uninitialized urandom read (16 bytes read)</span><br><span class="line">[    4.843600] systemd[1]: Listening on udev Kernel Socket.</span><br><span class="line">[    4.855139] systemd[1]: Reached target Swap.</span><br><span class="line">[    4.866153] systemd[1]: Listening on Journal Socket.</span><br><span class="line">[    4.886705] systemd[1]: Starting Restore / save the current clock...</span><br><span class="line">[    4.900496] systemd[1]: Condition check resulted in Huge Pages File System being skipped.</span><br><span class="line">[    4.912097] systemd[1]: Listening on initctl Compatibility Named Pipe.</span><br><span class="line">[    5.179601] i2c /dev entries driver</span><br><span class="line"></span><br><span class="line">Raspbian GNU/Linux 10 raspberrypi ttyS0</span><br><span class="line"></span><br><span class="line">raspberrypi login: </span><br></pre></td></tr></table></figure>

<p>从日志中我们可以看到，Linux内核为<code>5.10.11-v7l </code>  使用的是armv7l架构的版本，编译的gcc为arm，32位</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Linux version 5.10.11-v7l+ (dom@buildbot) (arm-linux-gnueabihf-gcc-8 (Ubuntu/Linaro 8.4.0-3ubuntu1) 8.4.0</span><br></pre></td></tr></table></figure>

<p>在串口里面我们可以直接登录。<br>到这里，串口的部分结束了，为了和后面做对比，我们登录后，看一下<code>/boot</code> 下的这个2个文件。<br><code>**cmdline.txt**</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">console=serial0,115200 console=tty1 root=PARTUUID=37dc5df3-02 rootfstype=ext4 elevator=deadline fsck.repair=yes rootwait</span><br></pre></td></tr></table></figure>

<p><code>cmdline.txt</code> 是树莓派BootLoader启动Linux内核时，传给内核的启动参数<br><code>console=serial0,115200</code> 设置串口控制台，波特率为115200<br><code>console=tty1</code> 设置tty1控制台<br><code>root=PARTUUID=37dc5df3-02</code> rootfs目录挂在的位置，这里的PARTUUID&#x3D;37dc5df3-02直接制定了分区号<br><code>rootfstype=ext4</code> rootfs的分区类型为ext4<br><code>elevator=``deadline</code> 磁盘扫描算法为deadline<br><code>fsck.repair=true</code> 开启磁盘修复能力<br><code>rootwait</code> 等待root设备加载完毕，如果不设置，会出现加载完内核后，无法找到磁盘的情况</p>
<p>Linux启动参数后面会有更多介绍，这里暂时列出现有的。</p>
<p><code>**config.txt**</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[all]</span><br><span class="line">start_x=0</span><br><span class="line">gpu_mem=128</span><br><span class="line">enable_uart=1</span><br></pre></td></tr></table></figure>

<p><code>start_x</code> 是否启动桌面<br><code>enable_uart</code> 开启串口<br><code>gpu_mem</code> 设置GPU内存<br>其他的配置暂时没列。</p>
<h3 id="2-2-构建64位Linux系统"><a href="#2-2-构建64位Linux系统" class="headerlink" title="2.2 构建64位Linux系统"></a>2.2 构建64位Linux系统</h3><p>在准备完串口工具后，我们正式开始构建系统</p>
<h4 id="2-2-1-编译U-boot（可选）"><a href="#2-2-1-编译U-boot（可选）" class="headerlink" title="2.2.1 编译U-boot（可选）"></a>2.2.1 编译U-boot（可选）</h4><p>在树莓派有自己的BootLoader，可以直接加载Kernel，也可以先加载U-Boot再启动Kernel，这里选择编译一下U-Boot。<br>64位构建过程参考 <a target="_blank" rel="noopener" href="https://www.cwiki.cn/archives/u-boot%E5%AE%89%E8%A3%85%E5%88%B0%E6%A0%91%E8%8E%93%E6%B4%BE">https://www.cwiki.cn/archives/u-boot安装到树莓派</a></p>
<h4 id="2-2-2-编译Linux-Kernel"><a href="#2-2-2-编译Linux-Kernel" class="headerlink" title="2.2.2 编译Linux Kernel"></a>2.2.2 编译Linux Kernel</h4><p>kernel 建议使用树莓派的，里面已经配置好了各种选项。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/raspberrypi/linux.git</span><br><span class="line">cd linux</span><br><span class="line">make distclean</span><br><span class="line">make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- bcm2711_defconfig</span><br><span class="line">make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- menuconfig # 可选择自己定制</span><br><span class="line">make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu-  -j12 # 自己设置编译进程数</span><br></pre></td></tr></table></figure>

<p>构建完成后，在<code>arch/arm64/boot</code> 目录下，可找到 <code>Image</code> <code>Image.gz</code> 镜像文件，其中<code>Image</code>  是未经压缩的Kernel文件，<code>Image.gz</code>  是gzip压缩过的镜像文件。64位的树莓派需要使用未经压缩的内核，即<code>Image</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">file Image</span> </span><br><span class="line">Image: MS-DOS executable PE32+ executable (EFI application) Aarch64 (stripped to external PDB), for MS Windows</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">file Image.gz</span> </span><br><span class="line">Image.gz: gzip compressed data, max compression, from Unix, original size modulo 2^32 21043712</span><br></pre></td></tr></table></figure>

<h4 id="2-2-3-通过BusyBox构建文件系统（可选）"><a href="#2-2-3-通过BusyBox构建文件系统（可选）" class="headerlink" title="2.2.3 通过BusyBox构建文件系统（可选）"></a>2.2.3 通过BusyBox构建文件系统（可选）</h4><p>下载BusyBox <a target="_blank" rel="noopener" href="https://busybox.net/">https://busybox.net/</a> ，解压后，进入Busybox目录</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- menuconfig</span><br><span class="line">make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- -j12</span><br></pre></td></tr></table></figure>

<p>选择静态编译 <code>Settings  ---&gt;</code> &#x2F; <code>--- Build Options</code> 下的 <code>Build static binary (no shared libs)</code> ，如果不选择静态编译，会带上很多so库，静态编译会方便一些。<br>编译后会有下面的显示，这个可以不用管，编译已经成功。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Static linking against glibc, can&#x27;t use --gc-sections</span><br><span class="line">Trying libraries: crypt m resolv rt</span><br><span class="line"> Library crypt is not needed, excluding it</span><br><span class="line"> Library m is needed, can&#x27;t exclude it (yet)</span><br><span class="line"> Library resolv is needed, can&#x27;t exclude it (yet)</span><br><span class="line"> Library rt is not needed, excluding it</span><br><span class="line"> Library m is needed, can&#x27;t exclude it (yet)</span><br><span class="line"> Library resolv is needed, can&#x27;t exclude it (yet)</span><br><span class="line">Final link with: m resolv</span><br></pre></td></tr></table></figure>

<p>构建Busybox文件系统：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- install</span><br></pre></td></tr></table></figure>

<p>在busybox目录下生成 <code>_install</code> 目录。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu-  PREFIX=/path/sdcark/rootfs install</span><br></pre></td></tr></table></figure>

<p>通过PREFIX参数可以制定安装位置，建议直接安装到需要的地方。具体参考 <a target="_blank" rel="noopener" href="https://git.busybox.net/busybox/tree/INSTALL">https://git.busybox.net/busybox/tree/INSTALL</a><br>在将BusyBox生成的install文件拷贝到rootfs目录后，进入rootfs目录，补充完所需目录。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir root dev etc bin sbin mnt sys proc lib home tmp var usr</span><br><span class="line">mkdir usr/sbin usr/bin usr/lib usr/modules</span><br><span class="line">mkdir mnt/usb mnt/nfs mnt/etc mnt/etc/init.d</span><br><span class="line">mkdir lib/modules</span><br><span class="line">sudo chmod 1777 tmp</span><br></pre></td></tr></table></figure>

<p>创建必要设备</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd dev</span><br><span class="line">sudo mknod -m 660 console c 5 1</span><br><span class="line">sudo mknod -m 660 null c 1 3</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cd etc</span><br><span class="line">vim fstab</span><br><span class="line"></span><br><span class="line">proc    /proc   proc    defaults    0   0</span><br><span class="line">none    /tmp    ramfs   defaults    0   0</span><br><span class="line">mdev    /dev    ramfs   defaults    0   0</span><br><span class="line">sysfs   /sys    sysfs   defaults    0   0</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cd etc/init.d</span><br><span class="line">vim rcS</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">! /bin/sh</span></span><br><span class="line"></span><br><span class="line">/bin/mount -a</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cd etc</span><br><span class="line">vim inittab</span><br><span class="line"></span><br><span class="line">::sysinit:/etc/init.d/rcS</span><br><span class="line">::respawn:-/bin/sh</span><br><span class="line">::restart:/sbin/init</span><br><span class="line">::ctrlaltdel:/bin/umount -a -r</span><br><span class="line">::shutdown:/bin/umount -a -r</span><br><span class="line">::shutdown:/sbin/swapoff –a</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">cd etc</span><br><span class="line">vim group</span><br><span class="line"></span><br><span class="line">root:*:0:</span><br><span class="line">daemon:*:1:</span><br><span class="line">bin:*:2:</span><br><span class="line">sys:*:3:</span><br><span class="line">adm:*:4:</span><br><span class="line">tty:*:5:</span><br><span class="line">disk:*:6:</span><br><span class="line">lp:*:7:lp</span><br><span class="line">mail:*:8:</span><br><span class="line">news:*:9:</span><br><span class="line">uucp:*:10:</span><br><span class="line">proxy:*:13:</span><br><span class="line">kmem:*:15:</span><br><span class="line">dialout:*:20:</span><br><span class="line">fax:*:21:</span><br><span class="line">voice:*:22:</span><br><span class="line">cdrom:*:24:</span><br><span class="line">floppy:*:25:</span><br><span class="line">tape:*:26:</span><br><span class="line">sudo:*:27:</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">cd etc </span><br><span class="line">vim profile</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">/etc/profile: system-wide .profile file <span class="keyword">for</span> the Bourne shells</span></span><br><span class="line"></span><br><span class="line">echo</span><br><span class="line">echo &quot;FileSystem is Ready ...&quot;</span><br><span class="line">echo</span><br><span class="line"></span><br><span class="line">USER=&quot;`id -un`&quot;</span><br><span class="line">LOGNAME=$USER</span><br><span class="line">PS1=&#x27;[\u@\h \W]\# &#x27;</span><br><span class="line">PATH=$PATH</span><br><span class="line">HOSTNAME=`/bin/hostname`</span><br><span class="line"></span><br><span class="line">export USER LOGNAME PS1 PATH</span><br></pre></td></tr></table></figure>

<p>至此完成了文件系统制作。也可以将这个文件系统打包成镜像，在Kernel启动时制定<code>initrd</code></p>
<h4 id="2-2-4-通过debootstrap构建基于Debian的文件系统（建议）"><a href="#2-2-4-通过debootstrap构建基于Debian的文件系统（建议）" class="headerlink" title="2.2.4 通过debootstrap构建基于Debian的文件系统（建议）"></a>2.2.4 通过debootstrap构建基于Debian的文件系统（建议）</h4><p>通过debootstrap制作文件系统就相当简单，建议以这种方式。debootstrap制作的文件系统包含了Debian所需的软件，文件系统完善，可直接使用apt等命令等。<br>在为了避免跨平台到来的麻烦，我们直接在树莓派现有系统上操作。<br>在树莓派上通过读卡器插入B卡</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo fdisk -l</span><br></pre></td></tr></table></figure>

<p>找到B的的rootfs分区</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mount /dev/sdb2 /mnt</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install debootstrap</span><br><span class="line">sudo debootstrap --arch=arm64 --foreign buster /mnt/ http://ftp.cn.debian.org/debian/</span><br><span class="line">sudo chroot /mnt/</span><br><span class="line">debootstrap/debootstrap --second-stage</span><br></pre></td></tr></table></figure>

<p>设置清华源</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">vim.tiny /etc/apt/sources.list</span><br><span class="line"></span><br><span class="line">deb https://mirrors.tuna.tsinghua.edu.cn/debian/ buster main contrib non-free</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">deb-src https://mirrors.tuna.tsinghua.edu.cn/debian/ buster main contrib non-free</span></span><br><span class="line">deb https://mirrors.tuna.tsinghua.edu.cn/debian/ buster-updates main contrib non-free</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">deb-src https://mirrors.tuna.tsinghua.edu.cn/debian/ buster-updates main contrib non-free</span></span><br><span class="line">deb https://mirrors.tuna.tsinghua.edu.cn/debian/ buster-backports main contrib non-free</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">deb-src https://mirrors.tuna.tsinghua.edu.cn/debian/ buster-backports main contrib non-free</span></span><br><span class="line">deb https://mirrors.tuna.tsinghua.edu.cn/debian-security buster/updates main contrib non-free</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">deb-src https://mirrors.tuna.tsinghua.edu.cn/debian-security buster/updates main contrib non-free</span></span><br></pre></td></tr></table></figure>

<p>配置时区、串口、SSH、Vimd等等</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">apt-get update</span><br><span class="line">passwd</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">localtime</span></span><br><span class="line">ln -sf /usr/slocaltimehare/zoneinfo/Asia/Shanghai /etc/localtime</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">serial port</span></span><br><span class="line">ln -s /lib/systemd/system/serial-getty\@.service /etc/systemd/system/getty.target.wants/serial-getty@ttyAMA0.service</span><br><span class="line"></span><br><span class="line">apt-get install vim ssh</span><br><span class="line">apt-get install ifupdown net-tools</span><br><span class="line">apt-get install udev sudo wget curl</span><br><span class="line">apt-get install alsa-utils libasound2-dev</span><br></pre></td></tr></table></figure>

<p>添加用户、设置网络、设置中文</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">USER=pi</span><br><span class="line">HOST=raspberry</span><br><span class="line">useradd -G sudo -m -s /bin/bash $USER</span><br><span class="line">passwd $USER</span><br><span class="line"></span><br><span class="line">echo $HOST &gt; /etc/hostname</span><br><span class="line">echo &quot;127.0.0.1    localhost.localdomain localhost&quot; &gt; /etc/hosts</span><br><span class="line">echo &quot;127.0.0.1    $HOST&quot; &gt;&gt; /etc/hosts</span><br><span class="line"></span><br><span class="line">cat &lt;&lt;EOF &gt; /etc/network/interfaces.d/eth0</span><br><span class="line"> auto eth0</span><br><span class="line"> iface eth0 inet static</span><br><span class="line"> address 192.168.1.9</span><br><span class="line"> gateway 192.168.1.1</span><br><span class="line"> netmask 255.255.255.0</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">apt-get install locales</span><br><span class="line">dpkg-reconfigure locales</span><br></pre></td></tr></table></figure>

<h3 id="2-3-配置引导"><a href="#2-3-配置引导" class="headerlink" title="2.3 配置引导"></a>2.3 配置引导</h3><p>拷贝编译好的Linux Kernel文件<code>Image</code> 到root分区，如果需要使用U-Boot引用，好需要将<code>u-boot.bin</code> 拷贝到root分区。</p>
<h4 id="2-3-1-配置树莓派基本引导文件"><a href="#2-3-1-配置树莓派基本引导文件" class="headerlink" title="2.3.1 配置树莓派基本引导文件"></a>2.3.1 配置树莓派基本引导文件</h4><p>将<a target="_blank" rel="noopener" href="https://github.com/raspberrypi/firmware.git">https://github.com/raspberrypi/firmware.git</a> 中root目录下的文件拷贝到root分区，参考<a target="_blank" rel="noopener" href="https://www.cwiki.cn/archives/u-boot%E5%AE%89%E8%A3%85%E5%88%B0%E6%A0%91%E8%8E%93%E6%B4%BE">https://www.cwiki.cn/archives/u-boot安装到树莓派</a></p>
<h4 id="2-3-2-配置启动内核Linux"><a href="#2-3-2-配置启动内核Linux" class="headerlink" title="2.3.2 配置启动内核Linux"></a>2.3.2 配置启动内核Linux</h4><p>修改cmdline.txt，这个文件里面是Linux启动参数</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">console=ttyAMA0,115200 console=serial0,115200 console=tty1 root=/dev/mmcblk0p2 rootfstype=ext4 elevator=deadline fsck.repair=yes rootwait</span><br></pre></td></tr></table></figure>

<p>修改config.txt为</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kernel=kernel8.img # 启动内核</span><br><span class="line">arm_64bit=1 # 64位</span><br><span class="line">enable_uart=1 # 打开串口</span><br></pre></td></tr></table></figure>

<p>当设置位U-Boot启动时，设置为</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kernel=u-boot.bin  # 启动内核</span><br><span class="line">arm_64bit=1 # 64位</span><br><span class="line">enable_uart=1 # 打开串口</span><br></pre></td></tr></table></figure>

<p>由于uboot编译的是树莓派的<code>rpi_4_defconfig</code> ，启动后自动加载配置，包括 <code>cmdline.txt</code> <code>config.txt</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">MESS:00:00:05.410376:0: arasan: arasan_emmc_open                                                         </span><br><span class="line">MESS:00:00:05.578211:0: brfs: File read: /mfs/sd/config.txt                                              </span><br><span class="line">MESS:00:00:05.581017:0: brfs: File read: 257 bytes                                                       </span><br><span class="line">MESS:00:00:05.648806:0: brfs: File read: /mfs/sd/config.txt                                              </span><br><span class="line">MESS:00:00:05.667051:0: brfs: File read: 257 bytes                                                       </span><br><span class="line">MESS:00:00:06.147877:0: gpioman: gpioman_get_pin_num: pin DISPLAY_DSI_PORT not defined                   </span><br><span class="line">MESS:00:00:06.155166:0: *** Restart logging                                                              </span><br><span class="line">MESS:00:00:06.160428:0: hdmi: HDMI:hdmi_get_state is deprecated, use hdmi_get_display_state instead      </span><br><span class="line">MESS:00:00:06.169785:0: hdmi: HDMI:hdmi_get_state is deprecated, use hdmi_get_display_state instead      </span><br><span class="line">MESS:00:00:06.175719:0: HDMI0: hdmi_pixel_encoding: 300000000                                            </span><br><span class="line">MESS:00:00:06.181188:0: HDMI1: hdmi_pixel_encoding: 300000000                                            </span><br><span class="line">MESS:00:00:06.191390:0: dtb_file &#x27;bcm2711-rpi-4-b.dtb&#x27;                                                   </span><br><span class="line">MESS:00:00:06.198297:0: brfs: File read: /mfs/sd/bcm2711-rpi-4-b.dtb</span><br><span class="line">MESS:00:00:06.201544:0: Loading &#x27;bcm2711-rpi-4-b.dtb&#x27; to 0x100 size 0xbd2d</span><br><span class="line">MESS:00:00:06.220694:0: brfs: File read: 48429 bytes</span><br><span class="line">MESS:00:00:06.232960:0: brfs: File read: /mfs/sd/overlays/overlay_map.dtb</span><br><span class="line">MESS:00:00:06.298769:0: brfs: File read: 1523 bytes</span><br><span class="line">MESS:00:00:06.301317:0: brfs: File read: /mfs/sd/config.txt</span><br><span class="line">MESS:00:00:06.311815:0: brfs: File read: 257 bytes</span><br><span class="line">MESS:00:00:06.315176:0: brfs: File read: /mfs/sd/cmdline.txt</span><br><span class="line">MESS:00:00:06.318896:0: Read command line from file &#x27;cmdline.txt&#x27;:</span><br><span class="line">MESS:00:00:06.324775:0: &#x27;console=serial0,115200 console=tty1 root=/dev/mmcblk0p2 rootfstype=ext4 elevator=deadline fsck.repair=yes rootwait&#x27;</span><br><span class="line">MESS:00:00:07.446637:0: brfs: File read: 115 bytes</span><br><span class="line">MESS:00:00:08.020689:0: brfs: File read: /mfs/sd/kernel8.img</span><br><span class="line">MESS:00:00:08.023242:0: Loading &#x27;kernel8.img&#x27; to 0x80000 size 0x76f687</span><br><span class="line">MESS:00:00:09.138881:0: Kernel relocated to 0x200000</span><br><span class="line">MESS:00:00:09.140734:0: Device tree loaded to 0x2eff3d00 (size 0xc203)</span><br><span class="line">MESS:00:00:09.148754:0: uart: Set PL011 baud rate to 103448.300000 Hz</span><br><span class="line">MESS:00:00:09.156064:0: uart: Baud rate change done...</span><br><span class="line">MESS:00:00:09.158083:0:[    0.000000] Booting Linux on physical CPU 0x0000000000 [0x410fd083]</span><br><span class="line">[    0.000000] Linux version 5.10.25-v8+ (zauther@zauther-MS-7B98) (aarch64-linux-gnu-gcc (GNU Toolchain for the A-profile Architecture 8.3-201</span><br></pre></td></tr></table></figure>

<p> 从串口中启动打印可以知道，u-boot启动时，会依次读取<code>config.txt </code> 配置，加载<code>bcm2711-rpi-4-b.dtb</code> 设备树描述文件， <code>overlay_map.dtb</code> 等。从<code>cmdline.txt</code> 中读取Linux Kernel启动参数，加载<code>kernel8.img</code> 默认文件名。加载kernel到内存位置 0x80000 ，重定位到0x200000 ；加载设备树到0x2eff3d00，设置串口波特率，并启动Kernel。<br>至此完成了Kernel的加载，并启动文件系统。<br>如果遇到文件系统出现损坏，为只读文件系统，可尝试切换到root用户，重新挂载根文件系统：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount -o remount rw /</span><br></pre></td></tr></table></figure>

<p>由于之前配置的是静态IP，通过SSH即可连接到树莓派。</p>
<p>DONE.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="https://blog.cwiki.cn/2021/03/29/U-Boot%20%E5%AE%89%E8%A3%85%E5%88%B0%E6%A0%91%E8%8E%93%E6%B4%BE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="zauther">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zzz个人博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/03/29/U-Boot%20%E5%AE%89%E8%A3%85%E5%88%B0%E6%A0%91%E8%8E%93%E6%B4%BE/" class="post-title-link" itemprop="url">U-Boot 安装到树莓派</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-03-29 23:01:00" itemprop="dateCreated datePublished" datetime="2021-03-29T23:01:00+08:00">2021-03-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-05-10 00:33:07" itemprop="dateModified" datetime="2022-05-10T00:33:07+08:00">2022-05-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>1.7k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>2 mins.</span>
            </span>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="SD卡分区"><a href="#SD卡分区" class="headerlink" title="SD卡分区"></a>SD卡分区</h3><p>将SD卡分区，通过fdisk命令分区为2个区，100M的boot区，剩下的rootfs区，boot区<br>boot区格式化为fat格式，rootfs格式化为ext4<br>将boot挂在到&#x2F;mnt&#x2F;boot位置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo mkfs.vfat /dev/sdb1</span><br><span class="line">sudo mount /dev/sdb1 /mnt/boot</span><br></pre></td></tr></table></figure>

<h3 id="准备树莓派Boot文件"><a href="#准备树莓派Boot文件" class="headerlink" title="准备树莓派Boot文件"></a>准备树莓派Boot文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/raspberrypi/firmware.git</span><br><span class="line">cd firmware</span><br><span class="line">cp -R boot/* /mnt/boot</span><br></pre></td></tr></table></figure>

<p>树莓派boot文件介绍</p>
<h4 id="bootcode-bin"><a href="#bootcode-bin" class="headerlink" title="bootcode.bin"></a>bootcode.bin</h4><p>这是引导加载程序，由SoC在引导时加载，它执行一些非常基本的设置，然后加载其中一个<code>start*.elf</code>文件。<code>bootcode.bin</code>在Raspberry Pi 4上未使用，因为它已由<a target="_blank" rel="noopener" href="https://www.raspberrypi.org/documentation/hardware/raspberrypi/booteeprom.md">板载EEPROM</a>中的启动代码替换</p>
<h4 id="start-elf和fixup-elf"><a href="#start-elf和fixup-elf" class="headerlink" title="start*.elf和fixup*.elf"></a>start*.elf和fixup*.elf</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">start4.elf，start4x.elf，start4cd.elf，start4db.elf</span><br><span class="line">fixup4.dat，fixup4x.dat，fixup4cd.dat，fixup4db.dat</span><br></pre></td></tr></table></figure>

<p><code>start*.elf</code>是基本固件，<code>start*x.elf</code>包括相机驱动程序和编解码器，<code>start*db.elf</code>是固件的调试版本，<code>start*cd.elf</code>是简化版本，不支持编解码器和3D之类的硬件块，并且在<code>gpu_mem=16</code>中指定时使用<code>config.txt</code></p>
<h4 id="fixup-dat"><a href="#fixup-dat" class="headerlink" title="fixup* .dat"></a>fixup* .dat</h4><p>这些是链接器文件，并且与<code>start*.elf</code>上一节中列出的文件配对</p>
<h4 id="cmdline-txt"><a href="#cmdline-txt" class="headerlink" title="cmdline.txt"></a>cmdline.txt</h4><p>引导时，内核命令行会传递到内核。</p>
<h4 id="config-txt"><a href="#config-txt" class="headerlink" title="config.txt"></a>config.txt</h4><p>包含许多用于设置Pi的配置参数</p>
<p>具体可见：<br><a target="_blank" rel="noopener" href="https://www.lxx1.com/pi/basis/raspberry_pi_version.html#%E5%BC%95%E5%AF%BC%E6%96%87%E4%BB%B6%E5%A4%B9%E5%86%85%E5%AE%B9">https://www.lxx1.com/pi/basis/raspberry_pi_version.html#%E5%BC%95%E5%AF%BC%E6%96%87%E4%BB%B6%E5%A4%B9%E5%86%85%E5%AE%B9</a></p>
<h3 id="GCC交叉编译"><a href="#GCC交叉编译" class="headerlink" title="GCC交叉编译"></a>GCC交叉编译</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://mirrors.tuna.tsinghua.edu.cn/armbian-releases/_toolchain/</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export ARCH_HOME=/&#123;PATH&#125;/gcc-arm-8.3-2019.03-x86_64-aarch64-linux-gnu</span><br><span class="line">export PATH=$PATH:$ARCH_HOME/bin</span><br></pre></td></tr></table></figure>

<h3 id="编译U-boot"><a href="#编译U-boot" class="headerlink" title="编译U-boot"></a>编译U-boot</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/u-boot/u-boot.git</span><br><span class="line">cd u-boot</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用刚才下载的交叉工具链</span></span><br><span class="line">export CROSS_COMPILE=aarch64-linux-gnu-</span><br><span class="line">make distclean</span><br><span class="line">make ARCH=arm CROSS_COMPILE=aarch64-linux-gnu- rpi_4_defconfig</span><br><span class="line">make ARCH=arm CROSS_COMPILE=aarch64-linux-gnu- -j12</span><br><span class="line">make ARCH=arm CROSS_COMPILE=aarch64-linux-gnu- distclean</span><br></pre></td></tr></table></figure>

<p><code>make distclean</code> 清理编译配置和编译产物</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo cp u-boot.bin /mnt/boot/kernel8.img</span><br></pre></td></tr></table></figure>

<p><code>u-boot.bin</code> 584.5k 大小</p>
<h3 id="USB串口调试"><a href="#USB串口调试" class="headerlink" title="USB串口调试"></a>USB串口调试</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install minicom</span><br><span class="line">sudo minicom -D /dev/ttyUSB0</span><br></pre></td></tr></table></figure>

<p>在控制台下通过组合键<code>Ctrl+A Z</code> 可以进入minicom 菜单。<br>组合键的用法是：先按<code>Ctrl+A</code>组合键，然后松开这两个键，再按Z键。另外还有一些常用的组合键。</p>
<p><code>S键</code>：发送文件到目标系统中；<br><code>W键</code>：自动卷屏。当显示的内容超过一行之后，自动将后面的内容换行。这个功能在查看内核的启动信息时很有用。<br><code>C键</code>：清除屏幕的显示内容；<br><code>B键</code>：浏览minicom的历史显示；<br><code>X键</code>：退出mInicom，会提示确认退出。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="https://blog.cwiki.cn/2021/03/27/Linux%E8%99%9A%E6%8B%9F%E9%95%9C%E5%83%8F%E5%88%9B%E5%BB%BA%E5%88%86%E5%8C%BA%E5%92%8CGrub2%E5%AE%89%E8%A3%85/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="zauther">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zzz个人博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/03/27/Linux%E8%99%9A%E6%8B%9F%E9%95%9C%E5%83%8F%E5%88%9B%E5%BB%BA%E5%88%86%E5%8C%BA%E5%92%8CGrub2%E5%AE%89%E8%A3%85/" class="post-title-link" itemprop="url">Linux虚拟镜像创建分区和Grub2安装</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-03-27 22:51:00" itemprop="dateCreated datePublished" datetime="2021-03-27T22:51:00+08:00">2021-03-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-05-10 00:33:07" itemprop="dateModified" datetime="2022-05-10T00:33:07+08:00">2022-05-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>7.3k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>7 mins.</span>
            </span>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="1-创建虚拟磁盘"><a href="#1-创建虚拟磁盘" class="headerlink" title="1. 创建虚拟磁盘"></a>1. 创建虚拟磁盘</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dd if=/dev/zero of=15g.img bs=1M count=15360 # 15GB</span><br></pre></td></tr></table></figure>

<h3 id="2-挂载img"><a href="#2-挂载img" class="headerlink" title="2. 挂载img"></a>2. 挂载img</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo losetup -l # 查看当前loop设备</span><br><span class="line">sudo losetup /dev/loop0 15g.img # 挂在到空闲的loop0上</span><br></pre></td></tr></table></figure>

<h3 id="3-img分区"><a href="#3-img分区" class="headerlink" title="3. img分区"></a>3. img分区</h3><p>通过fdisk对img分区<br>执行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo fdisk /dev/loop0</span><br></pre></td></tr></table></figure>

<p>进入提示：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">欢迎使用 fdisk (util-linux 2.34)。</span><br><span class="line">更改将停留在内存中，直到您决定将更改写入磁盘。</span><br><span class="line">使用写入命令前请三思。</span><br><span class="line"></span><br><span class="line">设备不包含可识别的分区表。</span><br><span class="line">创建了一个磁盘标识符为 0x7accf69c 的新 DOS 磁盘标签。</span><br><span class="line"></span><br><span class="line">命令(输入 m 获取帮助)：</span><br></pre></td></tr></table></figure>

<p>输入m，查看帮助</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">命令(输入 m 获取帮助)： m</span><br><span class="line"></span><br><span class="line">帮助：</span><br><span class="line"></span><br><span class="line">  DOS (MBR)</span><br><span class="line">   a   开关 可启动 标志</span><br><span class="line">   b   编辑嵌套的 BSD 磁盘标签</span><br><span class="line">   c   开关 dos 兼容性标志</span><br><span class="line"></span><br><span class="line">  常规</span><br><span class="line">   d   删除分区</span><br><span class="line">   F   列出未分区的空闲区</span><br><span class="line">   l   列出已知分区类型</span><br><span class="line">   n   添加新分区</span><br><span class="line">   p   打印分区表</span><br><span class="line">   t   更改分区类型</span><br><span class="line">   v   检查分区表</span><br><span class="line">   i   打印某个分区的相关信息</span><br><span class="line"></span><br><span class="line">  杂项</span><br><span class="line">   m   打印此菜单</span><br><span class="line">   u   更改 显示/记录 单位</span><br><span class="line">   x   更多功能(仅限专业人员)</span><br><span class="line"></span><br><span class="line">  脚本</span><br><span class="line">   I   从 sfdisk 脚本文件加载磁盘布局</span><br><span class="line">   O   将磁盘布局转储为 sfdisk 脚本文件</span><br><span class="line"></span><br><span class="line">  保存并退出</span><br><span class="line">   w   将分区表写入磁盘并退出</span><br><span class="line">   q   退出而不保存更改</span><br><span class="line"></span><br><span class="line">  新建空磁盘标签</span><br><span class="line">   g   新建一份 GPT 分区表</span><br><span class="line">   G   新建一份空 GPT (IRIX) 分区表</span><br><span class="line">   o   新建一份的空 DOS 分区表</span><br><span class="line">   s   新建一份空 Sun 分区表</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">命令(输入 m 获取帮助)：</span><br></pre></td></tr></table></figure>

<p>我们主要用到的有：</p>
<ul>
<li>n   添加新分区</li>
<li>t   更改分区类型</li>
<li>a   开关 可启动 标志</li>
<li>w   将分区表写入磁盘并退出</li>
<li>q   退出而不保存更改</li>
</ul>
<p>下面首先来分区，这里主要分为3个区，boot，rootfs和swap分区</p>
<ol>
<li>boot分区分200M，</li>
<li>swap分1G</li>
<li>其余分到rootfs</li>
</ol>
<h4 id="3-1-Boot分区"><a href="#3-1-Boot分区" class="headerlink" title="3.1 Boot分区"></a>3.1 Boot分区</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">命令(输入 m 获取帮助)： n</span><br><span class="line">分区类型</span><br><span class="line">   p   主分区 (0个主分区，0个扩展分区，4空闲)</span><br><span class="line">   e   扩展分区 (逻辑分区容器)</span><br><span class="line">选择 (默认 p)： p</span><br><span class="line">分区号 (1-4, 默认  1): </span><br><span class="line">第一个扇区 (2048-31457279, 默认 2048): </span><br><span class="line">Last sector, +/-sectors or +/-size&#123;K,M,G,T,P&#125; (2048-31457279, 默认 31457279): +200M</span><br><span class="line"></span><br><span class="line">创建了一个新分区 1，类型为“Linux”，大小为 200 MiB。</span><br></pre></td></tr></table></figure>

<p>一张硬盘上，主分区最多只能有4个，加入4个主分区未将磁盘使用完，剩下的空间是无法在分配的，也就是无法使用。如果一张硬盘上想有个多分区，做多3个主分区，至少一个扩展分区，剩下的为逻辑分区。在有逻辑分区的情况下，必须有一个以上的扩展分区。逻辑分区没有数量限制。<br>一张硬盘上，分区表一般位于硬盘某柱面的0磁头1扇区。而第1个分区表（也即主分区表）总是位于（0柱面，0磁头，1扇区），剩余的分区表位置可以由主分区表依次推导出来。硬盘第一个扇区（512字节）坏死了，那么这个硬盘就没法用了。</p>
<p><code>t</code> 可修改分区类型</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">命令(输入 m 获取帮助)： t</span><br><span class="line">已选择分区 1</span><br><span class="line">Hex 代码(输入 L 列出所有代码)： L</span><br><span class="line"></span><br><span class="line"> 0  空              24  NEC DOS         81  Minix / 旧 Linu bf  Solaris        </span><br><span class="line"> 1  FAT12           27  隐藏的 NTFS Win 82  Linux swap / So c1  DRDOS/sec (FAT-</span><br><span class="line"> 2  XENIX root      39  Plan 9          83  Linux           c4  DRDOS/sec (FAT-</span><br><span class="line"> 3  XENIX usr       3c  PartitionMagic  84  OS/2 隐藏 或 In c6  DRDOS/sec (FAT-</span><br><span class="line"> 4  FAT16 &lt;32M      40  Venix 80286     85  Linux 扩展      c7  Syrinx         </span><br><span class="line"> 5  扩展            41  PPC PReP Boot   86  NTFS 卷集       da  非文件系统数据 </span><br><span class="line"> 6  FAT16           42  SFS             87  NTFS 卷集       db  CP/M / CTOS / .</span><br><span class="line"> 7  HPFS/NTFS/exFAT 4d  QNX4.x          88  Linux 纯文本    de  Dell 工具      </span><br><span class="line"> 8  AIX             4e  QNX4.x 第2部分  8e  Linux LVM       df  BootIt         </span><br><span class="line"> 9  AIX 可启动      4f  QNX4.x 第3部分  93  Amoeba          e1  DOS 访问       </span><br><span class="line"> a  OS/2 启动管理器 50  OnTrack DM      94  Amoeba BBT      e3  DOS R/O        </span><br><span class="line"> b  W95 FAT32       51  OnTrack DM6 Aux 9f  BSD/OS          e4  SpeedStor      </span><br><span class="line"> c  W95 FAT32 (LBA) 52  CP/M            a0  IBM Thinkpad 休 ea  Rufus 对齐     </span><br><span class="line"> e  W95 FAT16 (LBA) 53  OnTrack DM6 Aux a5  FreeBSD         eb  BeOS fs        </span><br><span class="line"> f  W95 扩展 (LBA)  54  OnTrackDM6      a6  OpenBSD         ee  GPT            </span><br><span class="line">10  OPUS            55  EZ-Drive        a7  NeXTSTEP        ef  EFI (FAT-12/16/</span><br><span class="line">11  隐藏的 FAT12    56  Golden Bow      a8  Darwin UFS      f0  Linux/PA-RISC  </span><br><span class="line">12  Compaq 诊断     5c  Priam Edisk     a9  NetBSD          f1  SpeedStor      </span><br><span class="line">14  隐藏的 FAT16 &lt;3 61  SpeedStor       ab  Darwin 启动     f4  SpeedStor      </span><br><span class="line">16  隐藏的 FAT16    63  GNU HURD 或 Sys af  HFS / HFS+      f2  DOS 次要       </span><br><span class="line">17  隐藏的 HPFS/NTF 64  Novell Netware  b7  BSDI fs         fb  VMware VMFS    </span><br><span class="line">18  AST 智能睡眠    65  Novell Netware  b8  BSDI swap       fc  VMware VMKCORE </span><br><span class="line">1b  隐藏的 W95 FAT3 70  DiskSecure 多启 bb  Boot Wizard 隐  fd  Linux raid 自动</span><br><span class="line">1c  隐藏的 W95 FAT3 75  PC/IX           bc  Acronis FAT32 L fe  LANstep        </span><br><span class="line">1e  隐藏的 W95 FAT1 80  旧 Minix        be  Solaris 启动    ff  BBT            </span><br><span class="line">Hex 代码(输入 L 列出所有代码)： 83</span><br><span class="line">已将分区“Linux”的类型更改为“Linux”。</span><br></pre></td></tr></table></figure>

<h4 id="3-2-rootfs分区"><a href="#3-2-rootfs分区" class="headerlink" title="3.2 rootfs分区"></a>3.2 rootfs分区</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">命令(输入 m 获取帮助)： n</span><br><span class="line">分区类型</span><br><span class="line">   p   主分区 (1个主分区，0个扩展分区，3空闲)</span><br><span class="line">   e   扩展分区 (逻辑分区容器)</span><br><span class="line">选择 (默认 p)： p</span><br><span class="line">分区号 (2-4, 默认  2): </span><br><span class="line">第一个扇区 (411648-31457279, 默认 411648): </span><br><span class="line">Last sector, +/-sectors or +/-size&#123;K,M,G,T,P&#125; (411648-31457279, 默认 31457279): +14136M</span><br><span class="line"></span><br><span class="line">创建了一个新分区 2，类型为“Linux”，大小为 13.8 GiB。</span><br></pre></td></tr></table></figure>

<h4 id="3-3-swap分区"><a href="#3-3-swap分区" class="headerlink" title="3.3 swap分区"></a>3.3 swap分区</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">命令(输入 m 获取帮助)： n</span><br><span class="line">分区类型</span><br><span class="line">   p   主分区 (2个主分区，0个扩展分区，2空闲)</span><br><span class="line">   e   扩展分区 (逻辑分区容器)</span><br><span class="line">选择 (默认 p)： p</span><br><span class="line">分区号 (3,4, 默认  3): </span><br><span class="line">第一个扇区 (29362176-31457279, 默认 29362176): </span><br><span class="line">Last sector, +/-sectors or +/-size&#123;K,M,G,T,P&#125; (29362176-31457279, 默认 31457279): </span><br><span class="line"></span><br><span class="line">创建了一个新分区 3，类型为“Linux”，大小为 1023 MiB。</span><br><span class="line"></span><br><span class="line">命令(输入 m 获取帮助)： t</span><br><span class="line">分区号 (1-3, 默认  3): 3</span><br><span class="line">Hex 代码(输入 L 列出所有代码)： 82</span><br><span class="line"></span><br><span class="line">已将分区“Linux”的类型更改为“Linux swap / Solaris”。</span><br></pre></td></tr></table></figure>

<h4 id="3-4-设置Boot分区可以引导标记"><a href="#3-4-设置Boot分区可以引导标记" class="headerlink" title="3.4 设置Boot分区可以引导标记"></a>3.4 设置Boot分区可以引导标记</h4><p>磁盘开头的446字节内容特指为“主引导记录”（MBR），其后是4个16字节的“磁盘分区表”（DPT），以及2字节的结束标志（55AA）。446 + 4*16 + 2 &#x3D; 512字节。<br>可引导标记就是此分区的第一个扇区最后2个字节为55AA。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">命令(输入 m 获取帮助)： a</span><br><span class="line">分区号 (1-3, 默认  3): 1</span><br><span class="line"></span><br><span class="line">分区 1 的 可启动 标志已启用。</span><br></pre></td></tr></table></figure>

<p> <code>a</code> 设置可引导标记，选择分区1。 </p>
<h4 id="3-5-保存分区记录"><a href="#3-5-保存分区记录" class="headerlink" title="3.5 保存分区记录"></a>3.5 保存分区记录</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">命令(输入 m 获取帮助)： w</span><br><span class="line">分区表已调整。</span><br><span class="line">将调用 ioctl() 来重新读分区表。</span><br><span class="line">重新读取分区表失败。: 无效的参数</span><br><span class="line"></span><br><span class="line">内核仍在使用旧分区表。新分区表将在下次重启或运行 partprobe(8) 或 kpartx(8) 后生效。</span><br></pre></td></tr></table></figure>

<p>操作完后一定记得输入 <code>w</code> 保存。 <code>重新读取分区表失败</code> 可以忽略，此时已经成功了。</p>
<h4 id="3-6-卸载设备"><a href="#3-6-卸载设备" class="headerlink" title="3.6 卸载设备"></a>3.6 卸载设备</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo losetup -d /dev/loop0 # 卸载loop设备</span><br></pre></td></tr></table></figure>

<h4 id="3-7-查看img分区情况"><a href="#3-7-查看img分区情况" class="headerlink" title="3.7 查看img分区情况"></a>3.7 查看img分区情况</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">fdisk -l 15g.img     </span><br><span class="line"></span><br><span class="line">Disk 15g.img：15 GiB，16106127360 字节，31457280 个扇区</span><br><span class="line">单元：扇区 / 1 * 512 = 512 字节</span><br><span class="line">扇区大小(逻辑/物理)：512 字节 / 512 字节</span><br><span class="line">I/O 大小(最小/最佳)：512 字节 / 512 字节</span><br><span class="line">磁盘标签类型：dos</span><br><span class="line">磁盘标识符：0xc71ed2c6</span><br><span class="line"></span><br><span class="line">设备        启动     起点     末尾     扇区  大小 Id 类型</span><br><span class="line">15g.img1    *        2048   411647   409600  200M 83 Linux</span><br><span class="line">15g.img2           411648 29362175 28950528 13.8G 83 Linux</span><br><span class="line">15g.img3         29362176 31457279  2095104 1023M 82 Linux swap / Solaris</span><br></pre></td></tr></table></figure>

<h3 id="4-losetup挂载分区"><a href="#4-losetup挂载分区" class="headerlink" title="4. losetup挂载分区"></a>4. losetup挂载分区</h3><h4 id="4-1-将分区挂在到loop设备"><a href="#4-1-将分区挂在到loop设备" class="headerlink" title="4.1 将分区挂在到loop设备"></a>4.1 将分区挂在到loop设备</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-o （起始扇区 * 扇区大小）--sizelimit （扇区数量 * 扇区大小） 字节</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">2048 x 512 = 1048576       409600 x 512 = 209715200</span>        </span><br><span class="line">sudo losetup -f -o 1048576 --sizelimit 209715200 15g.img</span><br><span class="line">sudo losetup -f -o 210763776 --sizelimit 14822670336 15g.img</span><br><span class="line">sudo losetup -f -o 15033434112 --sizelimit 1072693248 15g.img</span><br></pre></td></tr></table></figure>

<p>由于 <code>15g.img</code> 中包含3个分区，如果使用 <code>losetup</code> 挂载，需要计算每个分区的其实位置和大小。<br>起始位置和偏移通过 3.7中的信息可以查看到。<br><code>-o</code> 起点<em>512<br><code>--sizelimit</code> 扇区</em>512</p>
<h4 id="4-2-查看挂载情况"><a href="#4-2-查看挂载情况" class="headerlink" title="4.2 查看挂载情况"></a>4.2 查看挂载情况</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo losetup -l</span><br><span class="line"></span><br><span class="line">NAME         SIZELIMIT      OFFSET AUTOCLEAR RO BACK-FILE                            DIO LOG-SEC</span><br><span class="line">/dev/loop1 14822670336   210763776         0  0 /home/zauther/zos/product/zos15g.img   0     512</span><br><span class="line">/dev/loop2  1072693248 15033434112         0  0 /home/zauther/zos/product/zos15g.img   0     512</span><br><span class="line">/dev/loop0   209715200     1048576         0  0 /home/zauther/zos/product/zos15g.img   0     512</span><br></pre></td></tr></table></figure>

<p>&#x2F;dev&#x2F;loop0  对应boot分区<br>&#x2F;dev&#x2F;loop1  对应rootfs分区<br>&#x2F;dev&#x2F;loop2  对应swap分区</p>
<h4 id="4-3-格式化分区"><a href="#4-3-格式化分区" class="headerlink" title="4.3 格式化分区"></a>4.3 格式化分区</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo mkfs.ext4 /dev/loop0</span><br><span class="line">sudo mkfs.ext4 /dev/loop1</span><br><span class="line">sudo mkswap /dev/loop2</span><br></pre></td></tr></table></figure>

<h4 id="4-4-挂载到mnt"><a href="#4-4-挂载到mnt" class="headerlink" title="4.4 挂载到mnt"></a>4.4 挂载到mnt</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir /mnt/boot</span><br><span class="line">sudo mkdir /mnt/rootfs </span><br><span class="line">sudo mount /dev/loop0 /mnt/boot</span><br><span class="line">sudo mount /dev/loop1 /mnt/rootfs</span><br></pre></td></tr></table></figure>

<h4 id="4-5-查看挂载情况"><a href="#4-5-查看挂载情况" class="headerlink" title="4.5 查看挂载情况"></a>4.5 查看挂载情况</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">df -h</span><br><span class="line"></span><br><span class="line">文件系统        容量  已用  可用 已用% 挂载点</span><br><span class="line">/dev/loop0      178M  216K  164M    1% /mnt/boot</span><br><span class="line">/dev/loop1       14G   41M   13G    1% /mnt/rootfs</span><br></pre></td></tr></table></figure>

<h3 id="5-kpartx-挂载分区"><a href="#5-kpartx-挂载分区" class="headerlink" title="5 kpartx 挂载分区"></a>5 kpartx 挂载分区</h3><p>通过<code>losetup</code>挂载需要手动计算位置，如果虚假镜像中包含分区表，可以通过<code>kpartx</code>一次性挂载</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kpartx -av 15g.img </span><br><span class="line"></span><br><span class="line">add map loop0p1 (253:2): 0 409600 linear 7:2 2048</span><br><span class="line">add map loop0p2 (253:3): 0 28950528 linear 7:2 411648</span><br><span class="line">add map loop0p3 (253:4): 0 2095104 linear 7:2 29362176</span><br></pre></td></tr></table></figure>

<p><code>-a</code> 添加镜像<br><code>-v</code> verbos信息打印<br><code>kpartx</code>会将 <code>15g.img</code> 挂载到 <code>/dev/loop0</code> 然后映射到 <code>/dev/mapper</code> 中：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ls /dev/mapper/       </span><br><span class="line"></span><br><span class="line">control  loop0p1  loop0p2  loop0p3</span><br></pre></td></tr></table></figure>

<p>可参考4.4 中，将<code>loop0p1  loop0p2  loop0p3</code>分别挂载到<code>/mnt</code>中：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mount  /dev/mapper/loop0p1 /mnt/boot</span><br></pre></td></tr></table></figure>

<h3 id="6-安装Grub2到设备"><a href="#6-安装Grub2到设备" class="headerlink" title="6 安装Grub2到设备"></a>6 安装Grub2到设备</h3><h4 id="6-1-安装grub"><a href="#6-1-安装grub" class="headerlink" title="6.1 安装grub"></a>6.1 安装grub</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt install grub2</span><br></pre></td></tr></table></figure>

<h4 id="6-2-安装Grub2到设备"><a href="#6-2-安装Grub2到设备" class="headerlink" title="6.2 安装Grub2到设备"></a>6.2 安装Grub2到设备</h4><p>强制安装到 <code>/dev/mapper/loop0p1</code> 即boot分区：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grub-install --boot-directory=/mnt/boot --force --allow-floppy /dev/mapper/loop0p1</span><br></pre></td></tr></table></figure>

<p><code>--boot-directory</code> boot分区中的目录位置，需要在boot分区中新建以下文件夹：<br>在执行完 <code>sudo mount  /dev/mapper/loop0p1 /mnt/boot</code> 后：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd /mnt/boot</span><br><span class="line">sudo mkdir -p mnt/boot</span><br><span class="line">cd mnt/boot</span><br><span class="line">sudo mkdir grub</span><br></pre></td></tr></table></figure>

<p>此时路径为 <code>/mnt/boot/mnt/boot</code> 。<br>当然也可以再前面直接挂载 <code>sudo mount  /dev/mapper/loop0p1 /mnt</code></p>
<h4 id="6-3-测试"><a href="#6-3-测试" class="headerlink" title="6.3 测试"></a>6.3 测试</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-x86_64 -nographic -drive format=raw,file=15g.img</span><br></pre></td></tr></table></figure>

<h3 id="7-通过Docker安装Grub2"><a href="#7-通过Docker安装Grub2" class="headerlink" title="7 通过Docker安装Grub2"></a>7 通过Docker安装Grub2</h3><h4 id="7-1-安装docker"><a href="#7-1-安装docker" class="headerlink" title="7.1 安装docker"></a>7.1 安装docker</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install apt-transport-https ca-certificates curl gnupg2 software-properties-common</span><br><span class="line">curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -</span><br><span class="line">sudo add-apt-repository \                                                                      </span><br><span class="line">   &quot;deb [arch=amd64] https://mirrors.tuna.tsinghua.edu.cn/docker-ce/linux/ubuntu \</span><br><span class="line"><span class="meta prompt_">   $</span><span class="language-bash">(lsb_release -cs) \</span></span><br><span class="line"><span class="language-bash">   stable<span class="string">&quot;</span></span></span><br><span class="line">sudo apt-get update                                                                            </span><br><span class="line">sudo apt-get install docker-ce</span><br></pre></td></tr></table></figure>

<h4 id="7-2-添加dockerhub加速镜像"><a href="#7-2-添加dockerhub加速镜像" class="headerlink" title="7.2 添加dockerhub加速镜像"></a>7.2 添加dockerhub加速镜像</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/docker/daemon.json</span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl restart docker</span><br></pre></td></tr></table></figure>

<p><code>/etc/docker/daemon.json</code> </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;registry-mirrors&quot;: [</span><br><span class="line">    &quot;https://hub-mirror.c.163.com&quot;,</span><br><span class="line">    &quot;https://mirror.baidubce.com&quot;,</span><br><span class="line">    &quot;https://registry.docker-cn.com&quot;,</span><br><span class="line">    &quot;https://reg-mirror.qiniu.com&quot;,</span><br><span class="line">    &quot;https://dockerhub.azk8s.cn&quot;,</span><br><span class="line">    &quot;https://docker.mirrors.ustc.edu.cn&quot;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="7-3-拉取Ubuntu镜像并执行"><a href="#7-3-拉取Ubuntu镜像并执行" class="headerlink" title="7.3 拉取Ubuntu镜像并执行"></a>7.3 拉取Ubuntu镜像并执行</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo docker pull ubuntu</span><br><span class="line">sudo docker run --rm -it -v ~/testgrub:/root/testgrub ubuntu</span><br></pre></td></tr></table></figure>

<p><code>--rm</code> 运行完退出容器后，自动销毁并删除镜像<br><code>-it</code> 以bash交互的形式运行容器<br><code>-v ~/testgrub:/root/testgrub </code> 本地卷:容器内卷 映射<br>在容器内按第6节中的操作，会发现loop设备无法使用。</p>
<h4 id="7-4-添加设备映射"><a href="#7-4-添加设备映射" class="headerlink" title="7.4 添加设备映射"></a>7.4 添加设备映射</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/docker/daemon.json</span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl restart docker</span><br></pre></td></tr></table></figure>

<p>添加设备映射并重启docker<br><code>/etc/docker/daemon.json</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;registry-mirrors&quot;: [</span><br><span class="line">    &quot;https://hub-mirror.c.163.com&quot;,</span><br><span class="line">    &quot;https://mirror.baidubce.com&quot;,</span><br><span class="line">    &quot;https://registry.docker-cn.com&quot;,</span><br><span class="line">    &quot;https://reg-mirror.qiniu.com&quot;,</span><br><span class="line">    &quot;https://dockerhub.azk8s.cn&quot;,</span><br><span class="line">    &quot;https://docker.mirrors.ustc.edu.cn&quot;</span><br><span class="line">  ],</span><br><span class="line">  &quot;storage-driver&quot;: &quot;devicemapper&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="8-卸载设备"><a href="#8-卸载设备" class="headerlink" title="8 卸载设备"></a>8 卸载设备</h3><p>在安装完grub2后，卸载设备</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo umount /mnt/boot/ </span><br><span class="line"></span><br><span class="line">sudo losetup -d /dev/loop0 # loop加载时</span><br><span class="line">sudo kpartx -dv 15g.img  # kpartx加载时 </span><br></pre></td></tr></table></figure>

<p>kpartx:<br><code>-d</code> 卸载镜像，会同时卸载<code>/dev/mapper/loop0p*</code> 和<code>/dev/loop0</code></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="https://blog.cwiki.cn/2021/03/26/%E6%A0%91%E8%8E%93%E6%B4%BE%E4%BD%BF%E7%94%A8V2ray/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="zauther">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zzz个人博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/03/26/%E6%A0%91%E8%8E%93%E6%B4%BE%E4%BD%BF%E7%94%A8V2ray/" class="post-title-link" itemprop="url">树莓派使用V2ray</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-03-26 00:10:00" itemprop="dateCreated datePublished" datetime="2021-03-26T00:10:00+08:00">2021-03-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-05-10 00:33:07" itemprop="dateModified" datetime="2022-05-10T00:33:07+08:00">2022-05-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>1.1k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>1 mins.</span>
            </span>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="安裝和更新-V2Ray"><a href="#安裝和更新-V2Ray" class="headerlink" title="安裝和更新 V2Ray"></a>安裝和更新 V2Ray</h4><p>地址：<br><a target="_blank" rel="noopener" href="https://github.com/v2fly/fhs-install-v2ray">https://github.com/v2fly/fhs-install-v2ray</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash &lt;(curl -L https://raw.githubusercontent.com/v2fly/fhs-install-v2ray/master/install-release.sh)</span><br></pre></td></tr></table></figure>

<h4 id="安裝最新發行的-geoip-dat-和-geosite-dat"><a href="#安裝最新發行的-geoip-dat-和-geosite-dat" class="headerlink" title="安裝最新發行的 geoip.dat 和 geosite.dat"></a>安裝最新發行的 geoip.dat 和 geosite.dat</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash &lt;(curl -L https://raw.githubusercontent.com/v2fly/fhs-install-v2ray/master/install-dat-release.sh)</span><br></pre></td></tr></table></figure>

<h4 id="移除-V2Ray"><a href="#移除-V2Ray" class="headerlink" title="移除 V2Ray"></a>移除 V2Ray</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash &lt;(curl -L https://raw.githubusercontent.com/v2fly/fhs-install-v2ray/master/install-release.sh) --remove</span><br></pre></td></tr></table></figure>

<h4 id="离线安装V2Ray"><a href="#离线安装V2Ray" class="headerlink" title="离线安装V2Ray"></a>离线安装V2Ray</h4><p>下载v2ray core:<br><a target="_blank" rel="noopener" href="https://github.com/v2ray/v2ray-core/releases">https://github.com/v2ray/v2ray-core/releases</a><br>树莓派选择：<br><a target="_blank" rel="noopener" href="https://github.com/v2ray/v2ray-core/releases/download/v4.28.2/v2ray-linux-arm32-v7a.zip">v2ray-linux-arm32-v7a.zip</a></p>
<p>安装：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget -O v2ray-install.sh  https://raw.githubusercontent.com/v2fly/fhs-install-v2ray/master/install-release.sh</span><br><span class="line">sudo ./v2ray-install.sh --local v2ray-linux-arm32-v7a.zip</span><br></pre></td></tr></table></figure>

<p>修改v2ray配置：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mousepad /usr/local/etc/v2ray/config.json</span><br></pre></td></tr></table></figure>

<p>启动v2ray:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systemctl start v2ray </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">或使用 service v2ray start</span></span><br><span class="line">ps -ef|grep v2ray</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">或使用 service v2ray status</span></span><br></pre></td></tr></table></figure>

<h4 id="代理配置"><a href="#代理配置" class="headerlink" title="代理配置"></a>代理配置</h4><p>编译安装 <code>ProxyChains-NG</code> 进行全局代理设置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/rofl0r/proxychains-ng.git</span><br><span class="line">cd proxychains-ng/</span><br><span class="line">./configure &amp;&amp; make &amp;&amp; make install</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改配置</span></span><br><span class="line">sudo mousepad /usr/local/etc/proxychains.conf</span><br></pre></td></tr></table></figure>

<p>proxychains.conf 内容：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">proxy_dns</span><br><span class="line">[ProxyList]</span><br><span class="line">socks5 127.0.0.1 1080</span><br></pre></td></tr></table></figure>

<p>测试：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains4 curl -I google.com</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="https://blog.cwiki.cn/2021/03/09/MAC%20%E4%B8%8B%20V8%20Android%E7%BC%96%E8%AF%91%E6%8C%87%E5%A2%99/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="zauther">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zzz个人博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/03/09/MAC%20%E4%B8%8B%20V8%20Android%E7%BC%96%E8%AF%91%E6%8C%87%E5%A2%99/" class="post-title-link" itemprop="url">MAC 下 V8 Android编译指墙</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-03-09 21:45:00" itemprop="dateCreated datePublished" datetime="2021-03-09T21:45:00+08:00">2021-03-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-05-10 00:33:07" itemprop="dateModified" datetime="2022-05-10T00:33:07+08:00">2022-05-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>6.4k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>6 mins.</span>
            </span>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="1-V8编译历程"><a href="#1-V8编译历程" class="headerlink" title="1. V8编译历程"></a>1. V8编译历程</h3><h4 id="1-1-前言"><a href="#1-1-前言" class="headerlink" title="1.1 前言"></a>1.1 前言</h4><ol>
<li>编译V8第一步就是保证能访问Google，当然不仅仅是为了查阅资料，最最重要的是V8源码下载的需要。</li>
<li>访问 <a target="_blank" rel="noopener" href="https://v8.dev/docs">https://v8.dev/docs</a> ，V8官网可查看到<a target="_blank" rel="noopener" href="https://v8.dev/docs/build">Building V8 from source</a> 根据所写一步步来就好。</li>
</ol>
<h4 id="1-2-编译环境搭建"><a href="#1-2-编译环境搭建" class="headerlink" title="1.2 编译环境搭建"></a>1.2 编译环境搭建</h4><p>V8源码通过depot_tools工具来管理，首先下载这个工具，作者以<code>/Users/*/Documents/test/v8</code> 目录为工作目录。</p>
<p>由于需要访问国外站，在获取depot_tools前需要做一些不可描述的事情：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">export</span> http_proxy=<span class="string">&quot;http://127.0.0.1:8001&quot;</span>; <span class="built_in">export</span> HTTP_PROXY=<span class="string">&quot;http://127.0.0.1:8001&quot;</span>; <span class="built_in">export</span> https_proxy=<span class="string">&quot;http://127.0.0.1:8001&quot;</span>; <span class="built_in">export</span> HTTPS_PROXY=<span class="string">&quot;http://127.0.0.1:8001&quot;</span></span></span><br></pre></td></tr></table></figure>

<p>开启代理后，将其假如环境变量。</p>
<p>进入<code>/Users/*/Documents/test/v8</code> 目录下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git <span class="built_in">clone</span> https://chromium.googlesource.com/chromium/tools/depot_tools.git</span></span><br></pre></td></tr></table></figure>

<p>通过git下载<code>depot_tools</code> 。</p>
<p>将工具集假如环境变量：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:/Users/*/Documents/test/v8/depot_tools</span></span><br></pre></td></tr></table></figure>

<p>fetch V8源码，并同步，fetch命令即depot_tools中的命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">fetch v8</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">gclient <span class="built_in">sync</span></span></span><br></pre></td></tr></table></figure>

<p>详见:<br><a target="_blank" rel="noopener" href="https://commondatastorage.googleapis.com/chrome-infra-docs/flat/depot_tools/docs/html/depot_tools_tutorial.html#_setting_up">https://commondatastorage.googleapis.com/chrome-infra-docs/flat/depot_tools/docs/html/depot_tools_tutorial.html#_setting_up</a></p>
<p>作者使用Mac，Xcode 为10.2.1，Xcode在10以后不支持32位的编译，一次需要同时安装10一下的版本。</p>
<p>到苹果下载官网 <a target="_blank" rel="noopener" href="https://developer.apple.com/download/more/">https://developer.apple.com/download/more/</a> 找到Xcode 10一下的版本并下载，我采用的是9.4.1。由于Xcode 体积比较大，通过浏览器下载比较慢。直接复制下载地址到下载器无法下载，需要将下载地址的请求头一并复制：打开chrome 开发者工具，点击下载后在Network可看到下载地址，右键下载地址，选择Copy-Copy as cURL，在终端粘贴后假如 <code>-O</code> 即可通过curl下载。</p>
<p>笔者将Xcode9.4.1 安装到：<code>/Applications/Xcode9.4.1/Xcode.app</code> </p>
<p>查看xcode的版本：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">xcode-select -p</span></span><br><span class="line">/Applications/Xcode.app/Contents/Developer</span><br></pre></td></tr></table></figure>

<p>切换xcode的版本：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo xcode-select -s /Applications/Xcode9.4.1/Xcode.app/Contents/Developer</span></span><br></pre></td></tr></table></figure>

<p>接下来进入编译的坑。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2021/03/09/MAC%20%E4%B8%8B%20V8%20Android%E7%BC%96%E8%AF%91%E6%8C%87%E5%A2%99/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="https://blog.cwiki.cn/2021/03/09/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="zauther">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zzz个人博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/03/09/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80/" class="post-title-link" itemprop="url">机器学习基础</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-03-09 19:51:00" itemprop="dateCreated datePublished" datetime="2021-03-09T19:51:00+08:00">2021-03-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-05-10 00:33:07" itemprop="dateModified" datetime="2022-05-10T00:33:07+08:00">2022-05-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">机器学习</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>4.1k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>4 mins.</span>
            </span>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="主要任务"><a href="#主要任务" class="headerlink" title="主要任务"></a>主要任务</h2><ul>
<li>分类（classification）：将实例数据划分到合适的类别中。<ul>
<li>应用实例：判断网站是否被黑客入侵（二分类 ），手写数字的自动识别（多分类）</li>
</ul>
</li>
<li>回归（regression）：主要用于预测数值型数据。<ul>
<li>应用实例：股票价格波动的预测，房屋价格的预测等。</li>
</ul>
</li>
</ul>
<h2 id="监督学习（supervised-learning）"><a href="#监督学习（supervised-learning）" class="headerlink" title="监督学习（supervised learning）"></a>监督学习（supervised learning）</h2><p>必须确定目标变量的值，以便机器学习算法可以发现特征和目标变量之间的关系。在监督学习中，给定一组数据，我们知道正确的输出结果应该是什么样子，并且知道在输入和输出之间有着一个特定的关系。 (包括：分类和回归)</p>
<h2 id="非监督学习（unsupervised-learing）"><a href="#非监督学习（unsupervised-learing）" class="headerlink" title="非监督学习（unsupervised learing）"></a>非监督学习（unsupervised learing）</h2><p>在机器学习，无监督学习的问题是，在未加标签的数据中，试图找到隐藏的结构。因为提供给学习者的实例是未标记的，因此没有错误或报酬信号来评估潜在的解决方案。</p>
<h2 id="强化学习"><a href="#强化学习" class="headerlink" title="强化学习"></a>强化学习</h2><p>这个算法可以训练程序做出某一决定。程序在某一情况下尝试所有的可能行动，记录不同行动的结果并试着找出最好的一次尝试来做决定。 属于这一类算法的有马尔可夫决策过程。</p>
<h4 id="机器学习过程"><a href="#机器学习过程" class="headerlink" title="机器学习过程"></a>机器学习过程</h4><p><img src="https://camo.githubusercontent.com/d8590769184ddfedf61412b48b779edcba563d4d/687474703a2f2f646174612e617061636865636e2e6f72672f696d672f41694c6561726e696e672f6d6c2f312e4d4c466f756e646174696f6e2f2545362539432542412545352539392541382545352541442541362545342542392541302545352539462542412545372541312538302545382541452541442545372542422538332545382542462538372545372541382538422e6a7067#align=left&display=inline&height=404&margin=%5Bobject%20Object%5D&originHeight=404&originWidth=1134&status=done&style=none&width=1134"></p>
<h4 id="算法汇总"><a href="#算法汇总" class="headerlink" title="算法汇总"></a>算法汇总</h4><p><img src="https://camo.githubusercontent.com/5e3d929718cc18352130414fc6c89ef281f89d31/687474703a2f2f646174612e617061636865636e2e6f72672f696d672f41694c6561726e696e672f6d6c2f312e4d4c466f756e646174696f6e2f6d6c5f616c676f726974686d2e6a7067#align=left&display=inline&height=404&margin=%5Bobject%20Object%5D&originHeight=404&originWidth=1130&status=done&style=none&width=1130"></p>
<h2 id="机器学习-使用"><a href="#机器学习-使用" class="headerlink" title="机器学习 使用"></a>机器学习 使用</h2><h4 id="选择算法需要考虑的两个问题"><a href="#选择算法需要考虑的两个问题" class="headerlink" title="选择算法需要考虑的两个问题"></a>选择算法需要考虑的两个问题</h4><ol>
<li>算法场景<ul>
<li>预测明天是否下雨，因为可以用历史的天气情况做预测，所以选择监督学习算法</li>
<li>给一群陌生的人进行分组，但是我们并没有这些人的类别信息，所以选择无监督学习算法、通过他们身高、体重等特征进行处理。</li>
</ul>
</li>
<li>需要收集或分析的数据是什么</li>
</ol>
<h4 id="选择算法图"><a href="#选择算法图" class="headerlink" title="选择算法图"></a>选择算法图</h4><p><img src="https://camo.githubusercontent.com/3d53b6befc5c3d0b6df6a890d1bc698de5205315/687474703a2f2f646174612e617061636865636e2e6f72672f696d672f41694c6561726e696e672f6d6c2f312e4d4c466f756e646174696f6e2f2545362539432542412545352539392541382545352541442541362545342542392541302545352539462542412545372541312538302d2545392538302538392545362538422541392545372541452539372545362542332539352e6a7067#align=left&display=inline&height=662&margin=%5Bobject%20Object%5D&originHeight=662&originWidth=1238&status=done&style=none&width=1238"></p>
<h4 id="机器学习-开发流程"><a href="#机器学习-开发流程" class="headerlink" title="机器学习 开发流程"></a>机器学习 开发流程</h4><ol>
<li>收集数据: 收集样本数据</li>
<li>准备数据: 注意数据的格式</li>
<li>分析数据: 为了确保数据集中没有垃圾数据；<ul>
<li>如果是算法可以处理的数据格式或可信任的数据源，则可以跳过该步骤；</li>
<li>另外该步骤需要人工干预，会降低自动化系统的价值。</li>
</ul>
</li>
<li>训练算法: [机器学习算法核心]如果使用无监督学习算法，由于不存在目标变量值，则可以跳过该步骤</li>
<li>测试算法: [机器学习算法核心]评估算法效果</li>
<li>使用算法: 将机器学习算法转为应用程序</li>
</ol>
<h1 id="深度学习中激活函数的优缺点"><a href="#深度学习中激活函数的优缺点" class="headerlink" title="深度学习中激活函数的优缺点"></a>深度学习中激活函数的优缺点</h1><p><strong>为什么要使用非线性激活函数？</strong></p>
<p>答：如果不使用激活函数，这种情况下每一层输出都是上一层输入的线性函数。无论神经网络有多少层，输出都是输入的线性函数，这样就和只有一个隐藏层的效果是一样的。这种情况相当于多层感知机(MLP)。</p>
<h2 id="激活函数"><a href="#激活函数" class="headerlink" title="激活函数"></a>激活函数</h2><p><img src="https://raw.githubusercontent.com/Zauther/figurebed/blog/imgs/activation_function.webp"></p>
<h2 id="1-Sigmoid函数"><a href="#1-Sigmoid函数" class="headerlink" title="1. Sigmoid函数"></a>1. Sigmoid函数</h2><p><strong>sigmoid函数</strong></p>
<p><img src="https://raw.githubusercontent.com/Zauther/figurebed/blog/imgs/sigmoid.svg"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">x =  np.arange(-<span class="number">10</span>,<span class="number">10</span>,<span class="number">0.01</span>)</span><br><span class="line">y=<span class="number">1</span>/(<span class="number">1</span>+np.exp(-x))</span><br><span class="line"></span><br><span class="line"><span class="comment">#sigmoid函数图像</span></span><br><span class="line">plt.plot(x,y,label=<span class="string">&#x27;sigmoid函数图像&#x27;</span>)</span><br><span class="line">plt.grid(color=<span class="string">&#x27;b&#x27;</span>,linewidth=<span class="string">&#x27;0.1&#x27;</span> ,linestyle=<span class="string">&#x27;--&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p><strong>sigmoid的导数</strong></p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/svg/286414/1615626070574-9232b0e5-c18b-48c8-b18c-b2d9b44d0865.svg#align=left&display=inline&height=51&margin=%5Bobject%20Object%5D&originHeight=51&originWidth=478&size=0&status=done&style=none&width=478"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#sigmoid导数图像</span></span><br><span class="line">dev_y = y*(<span class="number">1</span>-y)</span><br><span class="line">plt.plot(x,dev_y,label=<span class="string">&#x27;sigmoid导数图像&#x27;</span>)</span><br><span class="line">plt.grid(color=<span class="string">&#x27;b&#x27;</span>,linewidth=<span class="string">&#x27;0.2&#x27;</span> ,linestyle=<span class="string">&#x27;--&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p><strong>优点：</strong></p>
<ol>
<li>便于求导的平滑函数；</li>
<li>能压缩数据，保证数据幅度不会有问题；</li>
<li>适合用于前向传播。</li>
</ol>
<p><strong>缺点：</strong></p>
<ol>
<li>容易出现梯度消失（gradient vanishing）的现象：当激活函数接近饱和区时，变化太缓慢，导数接近0，根据后向传递的数学依据是微积分求导的链式法则，当前导数需要之前各层导数的乘积，几个比较小的数相乘，导数结果很接近0，从而无法完成深层网络的训练。</li>
<li>Sigmoid的输出不是0均值（zero-centered）的：这会导致后层的神经元的输入是非0均值的信号，这会对梯度产生影响。以 f&#x3D;sigmoid(wx+b)为例， 假设输入均为正数（或负数），那么对w的导数总是正数（或负数），这样在反向传播过程中要么都往正方向更新，要么都往负方向更新，导致有一种捆绑效果，使得收敛缓慢。</li>
<li>幂运算相对耗时</li>
</ol>
<h2 id="2-tanh函数"><a href="#2-tanh函数" class="headerlink" title="2. tanh函数"></a>2. tanh函数</h2><p><strong>tanh函数</strong></p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/svg/286414/1615626070582-be05cbae-f668-46fe-acee-fa862ee1184a.svg#align=left&display=inline&height=69&margin=%5Bobject%20Object%5D&originHeight=69&originWidth=337&size=0&status=done&style=none&width=337"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">x =  np.arange(-<span class="number">10</span>,<span class="number">10</span>,<span class="number">0.01</span>)</span><br><span class="line">y=(np.exp(x)-np.exp(-x))/(np.exp(x)+np.exp(-x))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#tanh函数图像</span></span><br><span class="line">plt.plot(x,y)</span><br><span class="line">plt.grid(color=<span class="string">&#x27;b&#x27;</span> , linewidth=<span class="string">&#x27;0.1&#x27;</span> ,linestyle=<span class="string">&#x27;--&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h1 id="tanh导数"><a href="#tanh导数" class="headerlink" title="tanh导数"></a><strong>tanh导数</strong></h1><p><img src="https://cdn.nlark.com/yuque/0/2021/svg/286414/1615626070575-609126fe-8170-4da6-823a-e0bf1d473c1c.svg#align=left&display=inline&height=25&margin=%5Bobject%20Object%5D&originHeight=25&originWidth=212&size=0&status=done&style=none&width=212"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#tanh导数图像</span></span><br><span class="line">dev_y=<span class="number">1</span>-np.square(y)</span><br><span class="line">plt.plot(x,dev_y)</span><br><span class="line">plt.grid(color=<span class="string">&#x27;b&#x27;</span> , linewidth=<span class="string">&#x27;0.1&#x27;</span> ,linestyle=<span class="string">&#x27;--&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>tanh函数将输入值压缩到 -1~1 的范围，因此它是0均值的，解决了Sigmoid函数的非zero-centered问题，但是它也存在梯度消失和幂运算的问题。</p>
<p>其实 tanh(x)&#x3D;2sigmoid(2x)-1</p>
<h2 id="3-ReLU-Rectified-Linear-Unit-修正的线性单元"><a href="#3-ReLU-Rectified-Linear-Unit-修正的线性单元" class="headerlink" title="3. ReLU(Rectified Linear Unit 修正的线性单元)"></a>3. ReLU(Rectified Linear Unit 修正的线性单元)</h2><p><strong>ReLU</strong></p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/svg/286414/1615626070587-7e1d9949-1ee2-4c7f-ac10-125c561ca2a8.svg#align=left&display=inline&height=49&margin=%5Bobject%20Object%5D&originHeight=49&originWidth=208&size=0&status=done&style=none&width=208"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">x =  np.arange(-<span class="number">10</span>,<span class="number">10</span>,<span class="number">0.01</span>)</span><br><span class="line">y=<span class="built_in">list</span>(<span class="built_in">map</span>(<span class="keyword">lambda</span> x:x <span class="keyword">if</span> x&gt;<span class="number">0</span> <span class="keyword">else</span> <span class="number">0</span>,x))</span><br><span class="line"></span><br><span class="line"><span class="comment">#ReLU函数图像</span></span><br><span class="line">plt.plot(x,y)</span><br><span class="line">plt.grid(color=<span class="string">&#x27;b&#x27;</span> , linewidth=<span class="string">&#x27;0.1&#x27;</span> ,linestyle=<span class="string">&#x27;--&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p><strong>ReLU函数导数</strong></p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/svg/286414/1615626070615-c09c6263-6790-4d44-8472-d7a7cbc0e83e.svg#align=left&display=inline&height=49&margin=%5Bobject%20Object%5D&originHeight=49&originWidth=212&size=0&status=done&style=none&width=212"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ReLU函数导数图像</span></span><br><span class="line">dev_y =<span class="built_in">list</span>(<span class="built_in">map</span>(<span class="keyword">lambda</span> x: <span class="number">1</span> <span class="keyword">if</span> x&gt;<span class="number">0</span> <span class="keyword">else</span> <span class="number">0</span>,x))</span><br><span class="line">plt.plot(x,dev_y)</span><br><span class="line">plt.grid(color=<span class="string">&#x27;b&#x27;</span> , linewidth=<span class="string">&#x27;0.1&#x27;</span> ,linestyle=<span class="string">&#x27;--&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p><strong>优点：</strong></p>
<ol>
<li>SGD算法的收敛速度比 sigmoid 和 tanh 快；（梯度不会饱和，解决了梯度消失问题）</li>
<li>计算复杂度低，不需要进行指数运算；</li>
<li>适合用于后向传播。</li>
</ol>
<p><strong>缺点：</strong></p>
<ol>
<li>ReLU的输出不是zero-centered；</li>
<li>Dead ReLU Problem（神经元坏死现象）：某些神经元可能永远不会被激活，导致相应参数永远不会被更新（在负数部分，梯度为0）。产生这种现象的两个原因：参数初始化问题；learning rate太高导致在训练过程中参数更新太大。 解决方法：采用Xavier初始化方法，以及避免将learning rate设置太大或使用adagrad等自动调节learning rate的算法。</li>
<li>ReLU不会对数据做幅度压缩，所以数据的幅度会随着模型层数的增加不断扩张。</li>
</ol>
<h2 id="4-Leakly-ReLU函数"><a href="#4-Leakly-ReLU函数" class="headerlink" title="4. Leakly ReLU函数"></a>4. Leakly ReLU函数</h2><p><strong>Leakly ReLU函数</strong></p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/svg/286414/1615626070591-621633f8-781a-4c2e-8830-e80854df13e8.svg#align=left&display=inline&height=49&margin=%5Bobject%20Object%5D&originHeight=49&originWidth=219&size=0&status=done&style=none&width=219"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">x =  np.arange(-<span class="number">10</span>,<span class="number">10</span>,<span class="number">0.01</span>)</span><br><span class="line">lambda1=<span class="number">0.1</span>   <span class="comment">#指定lambda为0.1</span></span><br><span class="line">y=<span class="built_in">list</span>(<span class="built_in">map</span>(<span class="keyword">lambda</span> x:x <span class="keyword">if</span> x&gt;<span class="number">0</span> <span class="keyword">else</span> lambda1*x,x))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#leaky ReLU函数图像</span></span><br><span class="line">plt.plot(x,y)</span><br><span class="line">plt.grid(color=<span class="string">&#x27;b&#x27;</span> , linewidth=<span class="string">&#x27;0.1&#x27;</span> ,linestyle=<span class="string">&#x27;--&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p><strong>Leaky ReLU函数导数</strong></p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/svg/286414/1615626070595-969cd82f-775e-4997-91de-dbe05c785759.svg#align=left&display=inline&height=49&margin=%5Bobject%20Object%5D&originHeight=49&originWidth=214&size=0&status=done&style=none&width=214"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#leaky ReLU函数导数图像</span></span><br><span class="line">dev_y = <span class="built_in">list</span>(<span class="built_in">map</span>(<span class="keyword">lambda</span> x: <span class="number">1</span> <span class="keyword">if</span> x&gt;<span class="number">0</span> <span class="keyword">else</span> lambda1,x))</span><br><span class="line">plt.plot(x,dev_y)</span><br><span class="line">plt.grid(color=<span class="string">&#x27;b&#x27;</span> , linewidth=<span class="string">&#x27;0.1&#x27;</span> ,linestyle=<span class="string">&#x27;--&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>用来解决ReLU带来的神经元坏死的问题，可以将0.01设置成一个变量a，其中a由后向传播学出来。_但是其表现并不一定比ReLU好_。</p>
<h2 id="5-ELU函数（指数线性函数）"><a href="#5-ELU函数（指数线性函数）" class="headerlink" title="5. ELU函数（指数线性函数）"></a>5. ELU函数（指数线性函数）</h2><p><strong>ELU函数（指数线性函数）</strong></p>
<p><img src="https://cdn.nlark.com/yuque/__latex/f899941d2acb44b4ffa1cc1dfdd903b8.svg#card=math&code=f%28x%29%3D%5Cbegin%7Bcases%7D%0Ax%2C%5Cquad%20if%20%5Cquad%20x%20%3C%200%20%5C%5C%5C%5C%0A%5Calpha%28e%5Ex-1%29%2C%5Cquad%20otherwise%0A%5Cend%7Bcases%7D&height=61&width=241"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">x =  np.arange(-10,10,0.01)</span><br><span class="line">y=list(map(lambda x:x if x&gt;0 else (np.exp(x)-1),x))</span><br><span class="line"></span><br><span class="line"># ELU函数（指数线性函数）图像</span><br><span class="line">plt.plot(x,y)</span><br><span class="line">plt.grid(color=&#x27;b&#x27;,linewidth=&#x27;0.1&#x27; ,linestyle=&#x27;--&#x27;)</span><br></pre></td></tr></table></figure>

<p><strong>ELU函数（指数线性函数）导数</strong></p>
<p><img src="https://cdn.nlark.com/yuque/__latex/aa44f735dfcacbb5534b9070249b0192.svg#card=math&code=f%28x%29%27%3D%5Cbegin%7Bcases%7D%0A1%2C%5Cquad%20if%20%5Cquad%20x%20%3C%200%20%5C%5C%5C%5C%0Af%28x%29%20%2B%20%5Calpha%20%2C%5Cquad%20otherwise%0A%5Cend%7Bcases%7D&height=61&width=240"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># dev_y = list(map(lambda x: 1 if x&gt;0 else lambda1,x))</span><br><span class="line"></span><br><span class="line"># ELU函数（指数线性函数）图像</span><br><span class="line"># plt.plot(x,dev_y)</span><br><span class="line"># plt.grid(color=&#x27;b&#x27;,linewidth=&#x27;0.1&#x27; ,linestyle=&#x27;--&#x27;)</span><br></pre></td></tr></table></figure>

<p>ELU有ReLU的所有优点，并且不会有 Dead ReLU问题，输出的均值接近0（zero-centered）。但是计算量大，其表现并不一定比ReLU好。。</p>
<h2 id="6-softmax"><a href="#6-softmax" class="headerlink" title="6. softmax"></a>6. softmax</h2><p><strong>softmax</strong></p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/svg/286414/1615626070597-cfb40bdd-fc19-4ef5-8f50-b42cbec0bd33.svg#align=left&display=inline&height=57&margin=%5Bobject%20Object%5D&originHeight=57&originWidth=133&size=0&status=done&style=none&width=133"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">import math</span><br><span class="line"></span><br><span class="line">z = np.arange(-10, 10, 0.05)</span><br><span class="line">exp_z = [math.exp(z) for z in z]</span><br><span class="line">sum_exp_z = sum(exp_z)</span><br><span class="line">softmax_z = [round(i / sum_exp_z, 6) for i in exp_z]</span><br><span class="line">plt.plot(z, softmax_z)</span><br><span class="line">plt.grid(color=&#x27;b&#x27;,linewidth=&#x27;0.1&#x27; ,linestyle=&#x27;--&#x27;)</span><br></pre></td></tr></table></figure>

<p>多分类任务，当类别数k＝2时，Softmax回归退化为Logistic回归。</p>
<h1 id="优化器"><a href="#优化器" class="headerlink" title="优化器"></a>优化器</h1><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/32626442">https://zhuanlan.zhihu.com/p/32626442</a></p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/gif/286414/1615626070588-ad4a7f87-c8d1-4d45-b38e-fc5d9e649eba.gif#align=left&display=inline&height=480&margin=%5Bobject%20Object%5D&originHeight=480&originWidth=620&size=0&status=done&style=none&width=620"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/gif/286414/1615626070576-53f54d5c-3464-4e71-bcc6-070ba700e787.gif#align=left&display=inline&height=557&margin=%5Bobject%20Object%5D&originHeight=557&originWidth=720&size=0&status=done&style=none&width=720"></p>
<h1 id="损失函数"><a href="#损失函数" class="headerlink" title="损失函数"></a>损失函数</h1><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/60302475">https://zhuanlan.zhihu.com/p/60302475</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="https://blog.cwiki.cn/2021/03/08/JupyterLab%20NoteBook%20%E5%AE%89%E8%A3%85/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="zauther">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zzz个人博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/03/08/JupyterLab%20NoteBook%20%E5%AE%89%E8%A3%85/" class="post-title-link" itemprop="url">JupyterLab NoteBook 安装</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-03-08 00:38:00" itemprop="dateCreated datePublished" datetime="2021-03-08T00:38:00+08:00">2021-03-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-05-10 00:33:07" itemprop="dateModified" datetime="2022-05-10T00:33:07+08:00">2022-05-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">机器学习</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>3.7k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>3 mins.</span>
            </span>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="1-安装python3虚拟环境"><a href="#1-安装python3虚拟环境" class="headerlink" title="1. 安装python3虚拟环境"></a>1. 安装python3虚拟环境</h3><p>此步骤根据需求而定，为了不影响系统Python环境，这里建立了虚拟环境。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd ~</span><br><span class="line">python3 -m venv .p3env</span><br><span class="line">source ~/.p3env/bin/activate</span><br></pre></td></tr></table></figure>

<h3 id="2-修改pip源"><a href="#2-修改pip源" class="headerlink" title="2 修改pip源"></a>2 修改pip源</h3><p>为了能加速下载Python依赖，这里修改了pip源，这步也可根据自己的需求来。<br>可参考清华大学的pip源设置：<a target="_blank" rel="noopener" href="https://mirrors.tuna.tsinghua.edu.cn/help/pypi/">https://mirrors.tuna.tsinghua.edu.cn/help/pypi/</a></p>
<h4 id="临时设置"><a href="#临时设置" class="headerlink" title="临时设置"></a>临时设置</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install -i https://pypi.tuna.tsinghua.edu.cn/simple some-package</span><br></pre></td></tr></table></figure>

<h4 id="全局设置"><a href="#全局设置" class="headerlink" title="全局设置"></a>全局设置</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple</span><br></pre></td></tr></table></figure>

<p>可以在 <code>~/.config/pip/pip.conf</code> 中找到pip全局配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">global</span>]</span><br><span class="line"><span class="string">index-url</span> <span class="string">=</span> <span class="string">https://pypi.tuna.tsinghua.edu.cn/simple</span></span><br></pre></td></tr></table></figure>

<p>不过在安装时，发现jupyter-lab下载还是很慢，因为jupyter-lab使用的时Piwheels源。<br>我们可以在配置里再加上aliyun的源。当然按理也可以直接设置aliyun的源为全局主源。或者继续添加其他的 <code>extra-index-url</code> 都行。这里主要演示怎么修改pip源的方法。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">global</span>]</span><br><span class="line"><span class="string">index-url</span> <span class="string">=</span> <span class="string">https://pypi.tuna.tsinghua.edu.cn/simple</span></span><br><span class="line"><span class="string">extra-index-url=https://mirrors.aliyun.com/pypi/simple</span></span><br></pre></td></tr></table></figure>

<h3 id="3-安装jupyter-lab"><a href="#3-安装jupyter-lab" class="headerlink" title="3 安装jupyter-lab"></a>3 安装jupyter-lab</h3><p>安装jupyter-lab的方法有好几种，这里使用pip： <a target="_blank" rel="noopener" href="https://jupyter.org/install">https://jupyter.org/install</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install jupyterlab</span><br></pre></td></tr></table></figure>

<h3 id="4-运行jupyter-lab"><a href="#4-运行jupyter-lab" class="headerlink" title="4 运行jupyter-lab"></a>4 运行jupyter-lab</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd workspace</span><br><span class="line">jupyter-lab</span><br></pre></td></tr></table></figure>

<p>在工作目录中执行，在桌面环境下，会直接打开浏览器: <a target="_blank" rel="noopener" href="http://localhost:8888/lab">http://localhost:8888/lab</a><br>在非桌面环境：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[I 2021-03-07 23:58:57.962 ServerApp] jupyterlab | extension was successfully linked.</span><br><span class="line">[I 2021-03-07 23:58:58.943 ServerApp] nbclassic | extension was successfully linked.</span><br><span class="line">[I 2021-03-07 23:58:59.044 LabApp] JupyterLab extension loaded from /home/pi/.p3env/lib/python3.7/site-packages/jupyterlab</span><br><span class="line">[I 2021-03-07 23:58:59.045 LabApp] JupyterLab application directory is /home/pi/.p3env/share/jupyter/lab</span><br><span class="line">[I 2021-03-07 23:58:59.054 ServerApp] jupyterlab | extension was successfully loaded.</span><br><span class="line">[I 2021-03-07 23:58:59.074 ServerApp] nbclassic | extension was successfully loaded.</span><br><span class="line">[I 2021-03-07 23:58:59.075 ServerApp] 启动notebooks 在本地路径: /home/user/.config/pip</span><br><span class="line">[I 2021-03-07 23:58:59.075 ServerApp] Jupyter Server 1.4.1 is running at:</span><br><span class="line">[I 2021-03-07 23:58:59.075 ServerApp] http://localhost:8888/lab</span><br><span class="line">[I 2021-03-07 23:58:59.076 ServerApp]  or http://127.0.0.1:8888/lab</span><br><span class="line">[I 2021-03-07 23:58:59.076 ServerApp] 使用control-c停止此服务器并关闭所有内核(两次跳过确认).</span><br><span class="line">[W 2021-03-07 23:58:59.089 ServerApp] 没有找到web浏览器: could not locate runnable browser.</span><br></pre></td></tr></table></figure>

<p>即使在局域网打开 <a target="_blank" rel="noopener" href="http://192.168.123.30:8888/">http://192.168.2.3:8888/</a> 也没用。<br>在非桌面环境下，可使用以下命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jupyter-lab --no-browser --ip=0.0.0.0 </span><br></pre></td></tr></table></figure>

<p><code>--ip=x.x.x.x</code> 表示运行访问的主机IP地址， <code>0.0.0.0 </code> 表示所有主机都可访问。<br>这个时候打开<a target="_blank" rel="noopener" href="http://192.168.123.30:8888/">http://192.168.2.3:8888/</a> 便可进入。</p>
<h3 id="5-配置外网环境"><a href="#5-配置外网环境" class="headerlink" title="5 配置外网环境"></a>5 配置外网环境</h3><p>在申请到公网IP，或者是运行在诸如VPS的云主机上时，需要对jupyter-lab进行配置。<br>由于公网访问，为了安全，我们对jupyter-lab设置密码。</p>
<h4 id="生成jupyter-lab配置文件"><a href="#生成jupyter-lab配置文件" class="headerlink" title="生成jupyter-lab配置文件"></a>生成jupyter-lab配置文件</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jupyter-lab --generate -config</span><br></pre></td></tr></table></figure>

<h4 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd ~/.jupyter</span><br><span class="line">vim jupyter_lab_config.py</span><br></pre></td></tr></table></figure>

<p>可以修改以下配置:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">c.ServerApp.password=&#x27;xxxx&#x27;</span><br><span class="line">c.ServerApp.password_required = True</span><br><span class="line">c.ServerApp.port = 8888</span><br></pre></td></tr></table></figure>

<p>具体的修改项可以根据自己的需求来<br>其中鉴权方式分为2中，一种是密码，一种是服务器token，服务器token会由服务器随机生成，不建议采用这种方式。服务器token可以在 <code>~/.jupyter/jupyter_server_config.json</code> 文件末尾找到。<br>修改配置也可以通过命令行来进行，比较推荐这种方式。</p>
<h4 id="修改密码"><a href="#修改密码" class="headerlink" title="修改密码"></a>修改密码</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jupyter-lab password</span><br></pre></td></tr></table></figure>

<h4 id="修改工作目录"><a href="#修改工作目录" class="headerlink" title="修改工作目录"></a>修改工作目录</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jupyter-lab --app-dir=&lt;Unicode&gt;</span><br></pre></td></tr></table></figure>

<h4 id="指端IP和端口号"><a href="#指端IP和端口号" class="headerlink" title="指端IP和端口号"></a>指端IP和端口号</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jupyter-lab --no-browser --ip=0.0.0.0 --port=5002</span><br></pre></td></tr></table></figure>

<p>具体由哪些方法见</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jupyter-lab --help </span><br></pre></td></tr></table></figure>

<p>为了提高安全性，可使用ssl设置https，具体修改的参数见 <code>jupyter-lab --help </code> 或者 <code>jupyter_lab_config.py</code> 文件。下面我使用的是nginx来方向代理。</p>
<h3 id="6-Nginx配置"><a href="#6-Nginx配置" class="headerlink" title="6 Nginx配置"></a>6 Nginx配置</h3><p>Nginx的使用可见文档：<a target="_blank" rel="noopener" href="https://www.cwiki.cn/archives/nginx%E4%BD%BF%E7%94%A8">https://www.cwiki.cn/archives/nginx%E4%BD%BF%E7%94%A8</a></p>
<h4 id="Nginx-配置文件"><a href="#Nginx-配置文件" class="headerlink" title="Nginx 配置文件"></a>Nginx 配置文件</h4><p>这里设置的端口是8080，可以按自己的需求，比如443，设置ssl证书。由于jupyter-lab会使用到websocket，需要进行设置。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">8080</span> ssl;</span><br><span class="line">    <span class="attribute">listen</span> [::]:<span class="number">8080</span> ssl;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">ssl_certificate</span> /path/xx.crt;</span><br><span class="line">    <span class="attribute">ssl_certificate_key</span> /path/xx.key;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">server_name</span> xxx.yy.zz;</span><br><span class="line"></span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://127.0.0.1:8888;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Real-Scheme <span class="variable">$scheme</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># WebSocket support</span></span><br><span class="line">        <span class="attribute">proxy_http_version</span> <span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Upgrade <span class="variable">$http_upgrade</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Connection <span class="string">&quot;upgrade&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">proxy_read_timeout</span> <span class="number">120s</span>;</span><br><span class="line">        <span class="attribute">proxy_next_upstream</span> <span class="literal">error</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="后台启动jupyter-lab"><a href="#后台启动jupyter-lab" class="headerlink" title="后台启动jupyter-lab"></a>后台启动jupyter-lab</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">source ~/.p3env/bin/activate</span><br><span class="line">nohup jupyter-lab --no-browser --ip=0.0.0.0 &gt; /path/x.log 2&gt;&amp;1 &amp; # log </span><br><span class="line">nohup jupyter-lab --no-browser --ip=0.0.0.0 &gt; /dev/null 2&gt;&amp;1 &amp; # 无log </span><br></pre></td></tr></table></figure>

<p>关于后台运行可参考其他文章</p>
<h4 id="启动Nginx"><a href="#启动Nginx" class="headerlink" title="启动Nginx"></a>启动Nginx</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">已经运行了nginx</span></span><br><span class="line">sudo service nginx reload</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">没运行</span></span><br><span class="line">sudo service nginx start</span><br></pre></td></tr></table></figure>

<p>这时在外网打开 <a target="_blank" rel="noopener" href="https://xxxx:8080/lab">https://xxxx:8080/lab</a>，输入密码就可以进入</p>
<p>DONE</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="https://blog.cwiki.cn/2021/03/04/Nginx%20%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="zauther">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zzz个人博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/03/04/Nginx%20%E4%BD%BF%E7%94%A8/" class="post-title-link" itemprop="url">Nginx 使用</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-03-04 22:23:00" itemprop="dateCreated datePublished" datetime="2021-03-04T22:23:00+08:00">2021-03-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-05-10 00:33:07" itemprop="dateModified" datetime="2022-05-10T00:33:07+08:00">2022-05-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>3.5k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>3 mins.</span>
            </span>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="Nginx安装和使用"><a href="#Nginx安装和使用" class="headerlink" title="Nginx安装和使用"></a>Nginx安装和使用</h3><h4 id="Ubuntu-安装Nginx"><a href="#Ubuntu-安装Nginx" class="headerlink" title="Ubuntu 安装Nginx"></a>Ubuntu 安装Nginx</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt install nginx</span><br></pre></td></tr></table></figure>

<h4 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h4><p>nginx 所有服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo service nginx</span><br><span class="line">Usage: nginx &#123;start|stop|restart|reload|force-reload|status|configtest|rotate|upgrade&#125;</span><br></pre></td></tr></table></figure>

<p>启动</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo service nginx start</span><br></pre></td></tr></table></figure>

<p>停止nginx服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo service nginx stop</span><br></pre></td></tr></table></figure>

<p>重新加载配置（修改完配置后执行）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo service nginx reload</span><br></pre></td></tr></table></figure>

<p>查看nginx状态，这里会打印出nginx conf中需要优化的地方</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">sudo service nginx status</span><br><span class="line"></span><br><span class="line">● nginx.service - A high performance web server and a reverse proxy server</span><br><span class="line">     Loaded: loaded (/lib/systemd/system/nginx.service; enabled; vendor preset: enabled)</span><br><span class="line">     Active: active (running) since Wed 2021-03-03 00:56:38 UTC; 1 day 13h ago</span><br><span class="line">       Docs: man:nginx(8)</span><br><span class="line">    Process: 62271 ExecReload=/usr/sbin/nginx -g daemon on; master_process on; -s reload (code=exited, status=0/SUCCESS)</span><br><span class="line">   Main PID: 1531 (nginx)</span><br><span class="line">      Tasks: 3 (limit: 1092)</span><br><span class="line">     Memory: 15.8M</span><br><span class="line">     CGroup: /system.slice/nginx.service</span><br><span class="line">             ├─ 1531 nginx: master process /usr/sbin/nginx -g daemon on; master_process on;</span><br><span class="line">             ├─62272 nginx: worker process</span><br><span class="line">             └─62275 nginx: worker process</span><br></pre></td></tr></table></figure>

<p>比如这种提示：<br> nginx: [warn] the “ssl” directive is deprecated, use the “listen … ssl”<br>ssl 这个配置已经失效，可采用</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="attribute">listen</span> <span class="number">443</span> ssl;</span><br><span class="line">  <span class="attribute">listen</span> [::]:<span class="number">443</span> ssl;</span><br><span class="line">  <span class="attribute">ssl_certificate</span> /etc/nginx/cert/1_www.xxx.cn_bundle.crt;</span><br><span class="line">  <span class="attribute">ssl_certificate_key</span> /etc/nginx/cert/2_www.xxx.cn.key;</span><br><span class="line">  <span class="attribute">ssl_protocols</span>         TLSv1 TLSv1.<span class="number">1</span> TLSv1.<span class="number">2</span>;</span><br><span class="line">  <span class="attribute">ssl_ciphers</span>           HIGH:!aNULL:!MD5;</span><br><span class="line">  <span class="attribute">server_name</span> www.xxx.cn;</span><br><span class="line">  <span class="attribute">client_max_body_size</span> <span class="number">1024m</span>;</span><br><span class="line"></span><br><span class="line">  <span class="section">location</span> / &#123;</span><br><span class="line">      ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>之后重启</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo service nginx restart</span><br></pre></td></tr></table></figure>

<h3 id="Nginx-配置"><a href="#Nginx-配置" class="headerlink" title="Nginx 配置"></a>Nginx 配置</h3><h4 id="nginx-下载服务配置"><a href="#nginx-下载服务配置" class="headerlink" title="nginx 下载服务配置"></a>nginx 下载服务配置</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">location /downloads &#123;  # url</span><br><span class="line">    alias   /tmp;  # 下载目录</span><br><span class="line">    autoindex on;</span><br><span class="line">    autoindex_exact_size on;</span><br><span class="line">    autoindex_localtime on;</span><br><span class="line">    charset utf-8,gbk;</span><br><span class="line">    index  index.html index.htm;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="nginx-内置变量"><a href="#nginx-内置变量" class="headerlink" title="nginx 内置变量"></a>nginx 内置变量</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$</span><span class="language-bash">args ：这个变量等于请求行中的参数，同<span class="variable">$query_string</span></span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">content_length ： 请求头中的Content-length字段。</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">content_type ： 请求头中的Content-Type字段。</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">document_root ： 当前请求在root指令中指定的值。</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">host ： 请求主机头字段，否则为服务器名称。</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">http_user_agent ： 客户端agent信息</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">http_cookie ： 客户端cookie信息</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">limit_rate ： 这个变量可以限制连接速率。</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">request_method ： 客户端请求的动作，通常为GET或POST。</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">remote_addr ： 客户端的IP地址。</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">remote_port ： 客户端的端口。</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">remote_user ： 已经经过Auth Basic Module验证的用户名。</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">request_filename ： 当前请求的文件路径，由root或<span class="built_in">alias</span>指令与URI请求生成。</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">scheme ： HTTP方法（如http，https）。</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">server_protocol ： 请求使用的协议，通常是HTTP/1.0或HTTP/1.1。</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">server_addr ： 服务器地址，在完成一次系统调用后可以确定这个值。</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">server_name ： 服务器名称。</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">server_port ： 请求到达服务器的端口号。</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">request_uri ： 包含请求参数的原始URI，不包含主机名，如：”/foo/bar.php?arg=baz”。</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">uri ： 不带请求参数的当前URI，<span class="variable">$uri</span>不包含主机名，如”/foo/bar.html”。</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">document_uri ： 与<span class="variable">$uri</span>相同。</span></span><br></pre></td></tr></table></figure>

<h4 id="http跳转https"><a href="#http跳转https" class="headerlink" title="http跳转https"></a>http跳转https</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">80</span> default_server;</span><br><span class="line">        <span class="attribute">listen</span> [::]:<span class="number">80</span> default_server;</span><br><span class="line"></span><br><span class="line">                <span class="comment"># 直接重定向</span></span><br><span class="line">       <span class="comment"># rewrite ^/(.*) https://www.xxx.cn/$1 permanent;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># SSL configuration</span></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        <span class="comment"># listen 443 ssl default_server;</span></span><br><span class="line">        <span class="comment"># listen [::]:443 ssl default_server;</span></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        <span class="comment"># Note: You should disable gzip for SSL traffic.</span></span><br><span class="line">        <span class="comment"># See: https://bugs.debian.org/773332</span></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        <span class="comment"># Read up on ssl_ciphers to ensure a secure configuration.</span></span><br><span class="line">        <span class="comment"># See: https://bugs.debian.org/765782</span></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        <span class="comment"># Self signed certs generated by the ssl-cert package</span></span><br><span class="line">        <span class="comment"># Don&#x27;t use them in a production server!</span></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        <span class="comment"># include snippets/snakeoil.conf;</span></span><br><span class="line"></span><br><span class="line">        <span class="attribute">root</span> /var/www/html;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Add index.php to the list if you are using PHP</span></span><br><span class="line">        <span class="attribute">index</span> index.html index.htm index.nginx-debian.html;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">server_name</span> _;</span><br><span class="line">                <span class="comment"># 错误也跳转</span></span><br><span class="line">        <span class="attribute">error_page</span>  <span class="number">404</span> https://www.xxx.cn/;</span><br><span class="line">                <span class="comment"># 301 重定向</span></span><br><span class="line">        <span class="attribute">return</span> <span class="number">301</span> https://www.xxx.cn/<span class="variable">$request_uri</span>;</span><br><span class="line"></span><br><span class="line">        <span class="section">location</span> / &#123;</span><br><span class="line">                <span class="comment"># First attempt to serve request as file, then</span></span><br><span class="line">                <span class="comment"># as directory, then fall back to displaying a 404.</span></span><br><span class="line">                <span class="attribute">try_files</span> <span class="variable">$uri</span> <span class="variable">$uri</span>/ =<span class="number">404</span>;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="nginx配置静态文件"><a href="#nginx配置静态文件" class="headerlink" title="nginx配置静态文件"></a>nginx配置静态文件</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="attribute">listen</span> <span class="number">443</span> ssl;</span><br><span class="line">  <span class="attribute">listen</span> [::]:<span class="number">443</span> ssl;</span><br><span class="line">  <span class="attribute">ssl_certificate</span> /etc/nginx/cert/1_www.xxx.cn_bundle.crt;</span><br><span class="line">  <span class="attribute">ssl_certificate_key</span> /etc/nginx/cert/2_www.xxx.cn.key;</span><br><span class="line">  <span class="attribute">ssl_protocols</span>         TLSv1 TLSv1.<span class="number">1</span> TLSv1.<span class="number">2</span>;</span><br><span class="line">  <span class="attribute">ssl_ciphers</span>           HIGH:!aNULL:!MD5;</span><br><span class="line">  <span class="attribute">server_name</span> www.xxx.cn;</span><br><span class="line">  <span class="attribute">client_max_body_size</span> <span class="number">1024m</span>;</span><br><span class="line"></span><br><span class="line">  <span class="section">location</span> /ads.txt &#123;</span><br><span class="line">      <span class="comment"># 目录</span></span><br><span class="line">    <span class="attribute">root</span> /var/www/html;</span><br><span class="line">    <span class="comment"># 文件</span></span><br><span class="line">    <span class="attribute">index</span> ads.txt;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="直接暴露目录"><a href="#直接暴露目录" class="headerlink" title="直接暴露目录"></a>直接暴露目录</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> / &#123;</span><br><span class="line">    <span class="comment"># 指定目录</span></span><br><span class="line">    <span class="attribute">root</span> /var/www/html;</span><br><span class="line">    <span class="comment"># 自动索引</span></span><br><span class="line">    <span class="attribute">autoindex</span> <span class="literal">on</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="https://blog.cwiki.cn/2021/01/31/%E4%BB%8Eqemu%E5%90%AF%E5%8A%A8Linux%E5%86%85%E6%A0%B8%E7%9C%8Blinux/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="zauther">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zzz个人博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/01/31/%E4%BB%8Eqemu%E5%90%AF%E5%8A%A8Linux%E5%86%85%E6%A0%B8%E7%9C%8Blinux/" class="post-title-link" itemprop="url">qemu启动Linux内核</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-01-31 22:01:12" itemprop="dateCreated datePublished" datetime="2021-01-31T22:01:12+08:00">2021-01-31</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-05-10 00:33:07" itemprop="dateModified" datetime="2022-05-10T00:33:07+08:00">2022-05-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>2.8k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>3 mins.</span>
            </span>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Linux-内核编译"><a href="#Linux-内核编译" class="headerlink" title="Linux 内核编译"></a>Linux 内核编译</h2><h5 id="准备Linux-kernel-源码"><a href="#准备Linux-kernel-源码" class="headerlink" title="准备Linux kernel 源码"></a>准备Linux kernel 源码</h5><p>下载地址：</p>
<p> <a target="_blank" rel="noopener" href="https://www.kernel.org/">https://www.kernel.org/</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">xz -d linux-5.10.12.tar.xz</span><br><span class="line">tar xvf linux-5.10.12.tar</span><br><span class="line">cd linux-5.10.12</span><br></pre></td></tr></table></figure>

<h5 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install build-essential</span><br><span class="line">sudo apt-get install libelf-dev</span><br><span class="line">sudo apt-get install libncurses-dev</span><br><span class="line">sudo apt-get install flex</span><br><span class="line">sudo apt-get install bison</span><br><span class="line">sudo apt install kernel-package build-essential libncurses5-dev fakeroot</span><br><span class="line">sudo apt install libssl-dev</span><br></pre></td></tr></table></figure>

<h5 id="编译源码"><a href="#编译源码" class="headerlink" title="编译源码"></a>编译源码</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make menuconfig</span><br><span class="line">make bzImage -j8</span><br></pre></td></tr></table></figure>

<p><code>make menuconfig</code> 配置kernel编译参数，可根据自己的需求进行设置，<code>ramfs</code> 一般是默认开启的，后面通过qemu运行需要使用到这个。</p>
<p>内存分为不同的类型，这里编译的是<code>x86_64</code> <code>bzImage</code> </p>
<p>内核的不同类型</p>
<blockquote>
<p>bzImage是vmlinuz经过gzip压缩后的文件，适用于大内核</p>
<p>vmlinux是未压缩的内核</p>
<p>vmlinuz是vmlinux的压缩文件。</p>
<p>vmlinux 是ELF文件，即编译出来的最原始的文件。</p>
<p>vmlinuz应该是由ELF文件vmlinux经过OBJCOPY后，并经过压缩后的文件</p>
<p>zImage是vmlinuz经过gzip压缩后的文件，适用于小内核</p>
</blockquote>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2021/01/31/%E4%BB%8Eqemu%E5%90%AF%E5%8A%A8Linux%E5%86%85%E6%A0%B8%E7%9C%8Blinux/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="https://blog.cwiki.cn/2020/08/10/%E4%BD%BF%E7%94%A8NDK%E5%92%8CCMake%E8%BF%9B%E8%A1%8C%E4%BA%A4%E5%8F%89%E7%BC%96%E8%AF%91%E5%BA%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="zauther">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zzz个人博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/08/10/%E4%BD%BF%E7%94%A8NDK%E5%92%8CCMake%E8%BF%9B%E8%A1%8C%E4%BA%A4%E5%8F%89%E7%BC%96%E8%AF%91%E5%BA%93/" class="post-title-link" itemprop="url">使用NDK和CMake进行交叉编译库</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-08-10 00:33:00" itemprop="dateCreated datePublished" datetime="2020-08-10T00:33:00+08:00">2020-08-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-05-10 00:33:07" itemprop="dateModified" datetime="2022-05-10T00:33:07+08:00">2022-05-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>2.5k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>2 mins.</span>
            </span>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a target="_blank" rel="noopener" href="https://developer.android.com/ndk/guides/cmake?hl=zh-cn">https://developer.android.com/ndk/guides/cmake?hl=zh-cn</a></p>
<p><a target="_blank" rel="noopener" href="https://cmake.org/cmake/help/latest/manual/cmake-toolchains.7.html#cross-compiling-for-android-with-the-ndk">https://cmake.org/cmake/help/latest/manual/cmake-toolchains.7.html#cross-compiling-for-android-with-the-ndk</a></p>
<p>NDK 通过工具链文件支持 CMake。工具链文件是用于自定义交叉编译工具链行为的 CMake 文件。用于 NDK 的工具链文件位于 NDK 中的 &#x2F;build&#x2F;cmake&#x2F;android.toolchain.cmake 内。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">/bin/bash</span></span><br><span class="line"></span><br><span class="line">export ANDROID_NDK=/opt/env/android-ndk-r14b</span><br><span class="line"></span><br><span class="line">rm -r build</span><br><span class="line">mkdir build &amp;&amp; cd build </span><br><span class="line"></span><br><span class="line">cmake -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK/build/cmake/android.toolchain.cmake \</span><br><span class="line">    -DANDROID_ABI=&quot;armeabi-v7a&quot; \</span><br><span class="line">    -DANDROID_NDK=$ANDROID_NDK \</span><br><span class="line">    -DANDROID_PLATFORM=android-22 \</span><br><span class="line">    ..</span><br><span class="line"></span><br><span class="line">make &amp;&amp; make install</span><br><span class="line"></span><br><span class="line">cd ..</span><br></pre></td></tr></table></figure>

<h4 id="opencv-NDK-编译"><a href="#opencv-NDK-编译" class="headerlink" title="opencv NDK 编译"></a>opencv NDK 编译</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">cmake -D CMAKE_BUILD_TYPE=RELEASE \</span><br><span class="line">    -D CMAKE_TOOLCHAIN_FILE=/Users/zauther/Library/Android/sdk/ndk-bundle/build/cmake/android.toolchain.cmake \</span><br><span class="line">    -D ANDROID_TOOLCHAIN=clang \</span><br><span class="line">    -D PYTHON_DEFAULT_EXECUTABLE=$(python -c &quot;import sys; print(sys.executable)&quot;)   \</span><br><span class="line">    -D PYTHON3_EXECUTABLE=$(python -c &quot;import sys; print(sys.executable)&quot;)   \</span><br><span class="line">    -D PYTHON3_NUMPY_INCLUDE_DIRS=$(python -c &quot;import numpy; print (numpy.get_include())&quot;) \</span><br><span class="line">    -D PYTHON3_INCLUDE_PATH=/usr/local/Cellar/python/3.7.7/Frameworks/Python.framework/Headers \</span><br><span class="line">    -D PYTHON3_PACKAGES_PATH=$(python -c &quot;from distutils.sysconfig import get_python_lib; print(get_python_lib())&quot;) \</span><br><span class="line">    -D PYTHON2_EXECUTABLE=/Users/zauther/Downloads/head_file/AliNNPython   \</span><br><span class="line">    -D PYTHON2_NUMPY_INCLUDE_DIRS=/Users/zauther/Downloads/head_file \</span><br><span class="line">    -D PYTHON2_INCLUDE_PATH=/Library/Frameworks/Python.framework/Versions/2.7/Headers \</span><br><span class="line">    -D PYTHON2_PACKAGES_PATH=$(python -c &quot;from distutils.sysconfig import get_python_lib; print(get_python_lib())&quot;) \</span><br><span class="line">    -D CMAKE_CXX_FLAGS=&quot;-std=c++11&quot; \</span><br><span class="line">    -D CMAKE_C_FLAGS=&quot;-D__ANDROID_API__=26&quot; \</span><br><span class="line">    -D ANDROID_NDK=/Users/zauther/Library/Android/sdk/ndk-bundle \</span><br><span class="line">    -D ANDROID_ABI=&quot;arm64-v8a&quot; \</span><br><span class="line">    -D ANDROID_NATIVE_API_LEVEL=android-26 \</span><br><span class="line">    -D ANDROID_NO_UNDEFINED=ON \</span><br><span class="line">    -D BUILD_opencv_python3=ON \</span><br><span class="line">    -D BUILD_opencv_python2=ON \</span><br><span class="line">    -D ANDROID_SO_UNDEFINED=OFF \</span><br><span class="line">    -D DBUILD_SHARED_LIBS=ON \</span><br><span class="line">    -D ENABLE_SOLUTION_FOLDERS=ON \</span><br><span class="line">    ../opencv/</span><br><span class="line"></span><br><span class="line">make opencv_python2</span><br><span class="line">make opencv_python3</span><br><span class="line">ninja -j 8 # -GNinja \</span><br></pre></td></tr></table></figure>

<p>需要使用android 24以上，<a target="_blank" rel="noopener" href="https://android.googlesource.com/platform/bionic/+/master/libc/include/bits/fortify/unistd.h">https://android.googlesource.com/platform/bionic/+/master/libc/include/bits/fortify/unistd.h</a> 中的__write_chk以来24以上的版本。</p>
<h2 id="NDK编译问题"><a href="#NDK编译问题" class="headerlink" title="NDK编译问题"></a>NDK编译问题</h2><ul>
<li>bionic&#x2F;libc&#x2F;include&#x2F;bits&#x2F;fortify&#x2F;stdio.h:43: error</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/9079766aa28c">https://www.jianshu.com/p/9079766aa28c</a><br>问题是android不同版本支持的api有变动，需要使用高版本的android，api列表如下：<br><a target="_blank" rel="noopener" href="https://android.googlesource.com/platform/bionic/+/master/android-changes-for-ndk-developers.md#available-in-api-level-23">https://android.googlesource.com/platform/bionic/+/master/android-changes-for-ndk-developers.md#available-in-api-level-23</a></p>
<ul>
<li>ndk 编译工具链</li>
</ul>
<p>一般位于NDK 中的 &#x2F;build&#x2F;cmake&#x2F;android.toolchain.cmake 内。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">zauther</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">27</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/zauther" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;zauther" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>



      </div>
      
        
<script type="text/javascript" charset="utf-8" src="/js/tagcloud.js"></script>
<script type="text/javascript" charset="utf-8" src="/js/tagcanvas.js"></script>
<div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div id="myCanvasContainer" class="widget tagcloud">
        <canvas width="250" height="250" id="resCanvas" style="width:100%">
            <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android/" rel="tag">Android</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/" rel="tag">C++</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CUDA/" rel="tag">CUDA</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Chromiun/" rel="tag">Chromiun</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Flutter/" rel="tag">Flutter</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Gradle/" rel="tag">Gradle</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Grub/" rel="tag">Grub</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JS/" rel="tag">JS</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nginx/" rel="tag">Nginx</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ReactNative/" rel="tag">ReactNative</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/U-Boot/" rel="tag">U-Boot</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/V2ray/" rel="tag">V2ray</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/V8/" rel="tag">V8</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/qemu/" rel="tag">qemu</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ubuntu/" rel="tag">ubuntu</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B7%A5%E5%85%B7/" rel="tag">工具</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BC%95%E5%AF%BC/" rel="tag">引导</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%A0%91%E8%8E%93%E6%B4%BE/" rel="tag">树莓派</a><span class="tag-list-count">3</span></li></ul>
        </canvas>
    </div>
</div>


    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zauther</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="Symbols count total">212k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">3:13</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
(adsbygoogle = window.adsbygoogle || []).push({
    google_ad_client: "ca-pub-1870807591456075",
    enable_page_level_ads: true
});
</script>




  

  

</body>
</html>
